
include "../common/install_ubuntu_server.testo"

[no_snapshots: true]
test exec_timeout: install_ubuntu_server_guest_additions {
	my_ubuntu_server {
		exec bash """
			sleep 1m
		""" timeout 5s
	}
}

[no_snapshots: true]
test exec_set_variable_1: install_ubuntu_server_guest_additions {
	my_ubuntu_server {
		exec bash """
			TMP=`uname -r`
			testo-guest-additions-cli set SOME_VARIABLE "$TMP"
		"""

		type "echo $<SOME_VARIABLE> > /root/file.txt"
		press Enter

		exec bash """
			cat /root/file.txt | grep "$<SOME_VARIABLE>"
		"""

		if (check "$<SOME_VARIABLE>") {
			print "hello from exec_set_variable_1!"
		}

		wait "$<SOME_VARIABLE>"
	}
}

[no_snapshots: true]
test exec_set_variable_2: install_ubuntu_server_guest_additions {
	my_ubuntu_server {
		exec bash """
			testo-guest-additions-cli set SOME_VARIABLE "2"
		"""

		if ("$<SOME_VARIABLE>" STREQUAL "2") {
			print "Success 1"
		} else {
			print "Fail 1"
		}

		exec bash """
			testo-guest-additions-cli set SOME_ANOTHER_VARIABLE "3"
		"""

		if ("$<SOME_ANOTHER_VARIABLE>" STREQUAL "2") {
			print "Success 2"
		} else {
			print "Fail 2"
		}
	}
}

[no_snapshots: true]
test copyto_from_unexisting_runtime: install_ubuntu_server_guest_additions {
	my_ubuntu_server {
		copyto "/some/unexisting_shit" "/somewhere" nocheck
	}
}

[no_snapshots: true]
test copyto_nocheck: install_ubuntu_server_guest_additions {
	my_ubuntu_server {
		exec bash "echo 'Hello world' > /tmp/something"
		copyfrom "/tmp/something" "/tmp/something"
		copyto "/tmp/something" "/tmp/something2" nocheck
		exec bash "cat /tmp/something2 | grep 'Hello world'"
	}
}
