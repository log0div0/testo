
include "centos_backend_qemu.testo"

[no_snapshots: true]
test centos_backend_qemu_plug_flash: centos_backend_qemu_install_ubuntu_server {
	centos {
		copyto "${TEST_ASSETS_DIR}/backend/install_guest_additions.testo" "/opt/scripts/install_guest_additions.testo"
		copyto "${TEST_ASSETS_DIR}/backend/action_flash.testo" "/opt/scripts/action_flash.testo"
		exec bash """
			set +o pipefail
			testo run /opt/scripts/action_flash.testo --stop_on_fail --test_spec plug_flash | grep "stop here"
		""" timeout 30m

		wait "my_ubuntu_server" && "Running"
		mouse dclick "my_ubuntu_server"
		wait "Welcome to Ubuntu"; sleep 5s
		type "clear"; press Enter
		type "sudo su"; press Enter
		wait "password for user"; type "1111"; press Enter
		wait "root@ubuntu"
		exec_bash("mount /dev/sdb1 /media")
	}
}

[no_snapshots: true]
test centos_backend_qemu_rollback_after_plug_flash: centos_backend_qemu_plug_flash {
	centos {
		exec bash """
			set +o pipefail
			testo run /opt/scripts/action_flash.testo --stop_on_fail --test_spec plug_flash | grep "stop here"
		""" timeout 30m
		wait "Welcome to Ubuntu"; sleep 5s
	}
}


[no_snapshots: true]
test centos_backend_qemu_plug_flash_with_files: centos_backend_qemu_install_ubuntu_server {
	centos {
		copyto "${TEST_ASSETS_DIR}/backend/install_guest_additions.testo" "/opt/scripts/install_guest_additions.testo"
		copyto "${TEST_ASSETS_DIR}/backend/action_flash.testo" "/opt/scripts/action_flash.testo"
		exec bash """
			mkdir /opt/flash_folder
			mkdir /opt/flash_folder/first_inner_folder
			mkdir /opt/flash_folder/first_inner_folder/super_inner_folder
			mkdir /opt/flash_folder/second_inner_folder
			mkdir /opt/flash_folder/third_inner_folder

			echo "Hello from root folder" > /opt/flash_folder/hello1.txt
			echo "Hello from first inner folder" > /opt/flash_folder/first_inner_folder/hello2.txt
			echo "Hello from second inner folder" > /opt/flash_folder/second_inner_folder/hello3.txt

			truncate -s 5000000000 /opt/flash_folder/first_inner_folder/super_inner_folder/super_big_file.txt
		"""

		exec bash """
			set +o pipefail
			testo run /opt/scripts/action_flash.testo --stop_on_fail --test_spec plug_flash_with_files --report_folder /opt/reports/ | grep "stop here"
		""" timeout 30m

		wait "my_ubuntu_server" && "Running"
		mouse dclick "my_ubuntu_server"
		wait "Welcome to Ubuntu"; sleep 5s
		type "clear"; press Enter
		type "sudo su"; press Enter
		wait "password for user"; type "1111"; press Enter
		wait "root@ubuntu"
		exec_bash("mount /dev/sdb1 /media")
		exec_bash("""[ -f "/media/hello1.txt" ]""")
		exec_bash("""[ -d "/media/first_inner_folder" ]""")
		exec_bash("""[ -d "/media/second_inner_folder" ]""")
		exec_bash("""[ -d "/media/third_inner_folder" ]""")
		exec_bash("""[ "$(cat /media/hello1.txt)" == "Hello from root folder" ]""")
		exec_bash("""[ -f "/media/first_inner_folder/hello2.txt" ]""")
		exec_bash("""[ -d "/media/first_inner_folder/super_inner_folder" ]""")
		exec_bash("""[ "$(cat /media/first_inner_folder/hello2.txt)" == "Hello from first inner folder" ]""")
		exec_bash("""[ -f "/media/second_inner_folder/hello3.txt" ]""")
		exec_bash("""[ "$(cat /media/second_inner_folder/hello3.txt)" == "Hello from second inner folder" ]""")
		exec_bash("""[ -f "/media/first_inner_folder/super_inner_folder/super_big_file.txt" ]""")
		exec_bash("""[ "$(stat -c %s /media/first_inner_folder/super_inner_folder/super_big_file.txt)" == "5000000000" ]""")
	}
}


[no_snapshots: true]
test centos_backend_qemu_flash_copyto: centos_backend_qemu_install_guest_additions {
	centos {
		copyto "${TEST_ASSETS_DIR}/backend/action_flash.testo" "/opt/scripts/action_flash.testo"
		exec bash """
			mkdir /opt/flash_folder
			mkdir /opt/flash_folder/first_inner_folder
			mkdir /opt/flash_folder/first_inner_folder/super_inner_folder
			mkdir /opt/flash_folder/second_inner_folder
			mkdir /opt/flash_folder/third_inner_folder

			echo "Hello from root folder" > /opt/flash_folder/hello1.txt
			echo "Hello from first inner folder" > /opt/flash_folder/first_inner_folder/hello2.txt
			echo "Hello from second inner folder" > /opt/flash_folder/second_inner_folder/hello3.txt

			truncate -s 5000000000 /opt/flash_folder/first_inner_folder/super_inner_folder/super_big_file.txt
		"""

		exec bash """
			set +o pipefail
			testo run /opt/scripts/action_flash.testo --stop_on_fail --test_spec flash_copyto --report_folder /opt/reports/ | grep "stop here"
		""" timeout 30m

		wait "my_ubuntu_server" && "Running"
		mouse dclick "my_ubuntu_server"
		wait "Welcome to Ubuntu"; sleep 5s
		type "clear"; press Enter
		type "sudo su"; press Enter
		wait "password for user"; type "1111"; press Enter
		wait "root@ubuntu"
		exec_bash("mount /dev/sdb1 /media")
		exec_bash("""[ -f "/media/some/inner/shit/hello1.txt" ]""")
		exec_bash("""[ -d "/media/some/inner/shit/first_inner_folder" ]""")
		exec_bash("""[ -d "/media/some/inner/shit/second_inner_folder" ]""")
		exec_bash("""[ -d "/media/some/inner/shit/third_inner_folder" ]""")
		exec_bash("""[ "$(cat /media/some/inner/shit/hello1.txt)" == "Hello from root folder" ]""")
		exec_bash("""[ -f "/media/some/inner/shit/first_inner_folder/hello2.txt" ]""")
		exec_bash("""[ -d "/media/some/inner/shit/first_inner_folder/super_inner_folder" ]""")
		exec_bash("""[ "$(cat /media/some/inner/shit/first_inner_folder/hello2.txt)" == "Hello from first inner folder" ]""")
		exec_bash("""[ -f "/media/some/inner/shit/second_inner_folder/hello3.txt" ]""")
		exec_bash("""[ "$(cat /media/some/inner/shit/second_inner_folder/hello3.txt)" == "Hello from second inner folder" ]""")
		exec_bash("""[ -f "/media/some/inner/shit/first_inner_folder/super_inner_folder/super_big_file.txt" ]""")
		exec_bash("""[ "$(stat -c %s /media/some/inner/shit/first_inner_folder/super_inner_folder/super_big_file.txt)" == "5000000000" ]""")
	}
}

[no_snapshots: true]
test centos_backend_qemu_flash_copyto_timeout: centos_backend_qemu_install_guest_additions {
	centos {
		copyto "${TEST_ASSETS_DIR}/backend/action_flash.testo" "/opt/scripts/action_flash.testo"
		exec bash """
			mkdir /opt/flash_folder
			mkdir /opt/flash_folder/first_inner_folder
			mkdir /opt/flash_folder/first_inner_folder/super_inner_folder
			mkdir /opt/flash_folder/second_inner_folder
			mkdir /opt/flash_folder/third_inner_folder

			echo "Hello from root folder" > /opt/flash_folder/hello1.txt
			echo "Hello from first inner folder" > /opt/flash_folder/first_inner_folder/hello2.txt
			echo "Hello from second inner folder" > /opt/flash_folder/second_inner_folder/hello3.txt

			truncate -s 5000000000 /opt/flash_folder/first_inner_folder/super_inner_folder/super_big_file.txt
		"""

		exec bash """
			set +o pipefail
			set +e
			output=$(testo run /opt/scripts/action_flash.testo --stop_on_fail --test_spec flash_copyto_timeout)
			[[ $output == *"Error while performing action copyto"* ]]
			[[ $output == *"Timeout was triggered"* ]]
		""" timeout 30m
	}
}

[no_snapshots: true]
test centos_backend_qemu_flash_copyfrom: centos_backend_qemu_install_guest_additions {
	centos {
		copyto "${TEST_ASSETS_DIR}/backend/action_flash.testo" "/opt/scripts/action_flash.testo"

		exec bash """
			set +o pipefail
			testo run /opt/scripts/action_flash.testo --stop_on_fail --test_spec flash_copyfrom
		""" timeout 30m


		exec bash """[ -f "/opt/some/inner/shit/hello1.txt" ]"""
		exec bash """[ -d "/opt/some/inner/shit/first_inner_folder" ]"""
		exec bash """[ -d "/opt/some/inner/shit/second_inner_folder" ]"""
		exec bash """[ -d "/opt/some/inner/shit/third_inner_folder" ]"""
		exec bash """[ "$(cat /opt/some/inner/shit/hello1.txt)" == "Hello from root folder" ]"""
		exec bash """[ -f "/opt/some/inner/shit/first_inner_folder/hello2.txt" ]"""
		exec bash """[ -d "/opt/some/inner/shit/first_inner_folder/super_inner_folder" ]"""
		exec bash """[ "$(cat /opt/some/inner/shit/first_inner_folder/hello2.txt)" == "Hello from first inner folder" ]"""
		exec bash """[ -f "/opt/some/inner/shit/second_inner_folder/hello3.txt" ]"""
		exec bash """[ "$(cat /opt/some/inner/shit/second_inner_folder/hello3.txt)" == "Hello from second inner folder" ]"""
		exec bash """[ -f "/opt/some/inner/shit/first_inner_folder/super_inner_folder/super_big_file.txt" ]"""
		exec bash """[ "$(stat -c %s /opt/some/inner/shit/first_inner_folder/super_inner_folder/super_big_file.txt)" == "5000000000" ]"""
	}
}

[no_snapshots: true]
test centos_backend_qemu_plug_flash_exceptions: centos_install_testo_cpu {
	centos {
		copyto "${TEST_ASSETS_DIR}/backend/common.testo" "/opt/scripts/common.testo"
		copyto "${TEST_ASSETS_DIR}/backend/install_ubuntu.testo" "/opt/scripts/install_ubuntu.testo"
		copyto "${TEST_ASSETS_DIR}/backend/install_guest_additions.testo" "/opt/scripts/install_guest_additions.testo"
		copyto "${TEST_ASSETS_DIR}/backend/action_flash.testo" "/opt/scripts/action_flash.testo"
		exec bash """
			set +o pipefail
			testo run /opt/scripts/action_flash.testo --test_spec plug_already_plugged_flash | grep "Flash drive my_flash is already plugged into vm my_ubuntu_server. You should unplug it first"
			testo run /opt/scripts/action_flash.testo --test_spec plug_already_plugged_flash_2 | grep "Another flash drive my_flash is already plugged into vm my_ubuntu_server. You should unplug it first"
			testo run /opt/scripts/action_flash.testo --test_spec plug_already_plugged_flash_3 | grep "Flash drive my_flash is already plugged into vm dummy_machine. You should unplug it first"
			testo run /opt/scripts/action_flash.testo --test_spec plug_already_plugged_flash_4 | grep "Flash drive my_flash is already plugged into vm dummy_machine. You should unplug it first"
			testo run /opt/scripts/action_flash.testo --test_spec finish_test_with_plugged_flash | grep "Please unplug the flash drive before the end of the test"
		""" timeout 30m

		exec bash """
			testo run /opt/scripts/action_flash.testo --test_spec flash_macro_call | grep "Hello world from flash macro"
		""" timeout 30m
	}
}

[no_snapshots: true]
test centos_backend_qemu_exec_timeout: centos_backend_qemu_install_guest_additions {
	centos {
		copyto "${TEST_ASSETS_DIR}/backend/action_ga.testo" "/opt/scripts/action_ga.testo"

		exec bash """
			set +o pipefail
			set +e
			output=$(testo run /opt/scripts/action_ga.testo --stop_on_fail --test_spec exec_timeout)
			[[ $output == *"Error while performing action exec bash"* ]]
			[[ $output == *"Timeout was triggered"* ]]
		""" timeout 30m

	}
}