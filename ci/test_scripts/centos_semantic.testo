
include "centos.testo"

[no_snapshots: true]
test centos_semantic: centos_install_testo {
	centos {
		copyto "${TEST_ASSETS_DIR}/semantic" "/opt/scripts/semantic"

		exec bash "cp /opt/scripts/semantic/* /"

		exec bash """
			set +o pipefail
			set +e
			output=$(testo run /0001.testo 2>&1 > /dev/null)
			[[ $output == *"/0001.testo:6:1: Error: test \\"A\\" is already defined"* ]]
			[[ $output == *"/0001.testo:2:1: note: previous declaration was here"* ]]
		"""

		exec bash """
			set +o pipefail
			set +e
			output=$(testo run /0002.testo 2>&1 > /dev/null)
			[[ $output == *"/0002.testo:6:1: Error: macro \\"A\\" is already defined"* ]]
			[[ $output == *"/0002.testo:2:1: note: previous declaration was here"* ]]
		"""

		exec bash """
			set +o pipefail
			set +e
			output=$(testo run /0003.testo 2>&1 > /dev/null)
			[[ $output == *"/0003.testo:4:1: Error: param \\"A\\" is already defined"* ]]
			[[ $output == *"/0003.testo:2:1: note: previous declaration was here"* ]]
		"""

		exec bash """
			set +o pipefail
			set +e
			output=$(testo run /0004.testo 2>&1 > /dev/null)
			[[ $output == *"/0004.testo:6:1: Error: virtual machine \\"A\\" is already defined"* ]]
			[[ $output == *"/0004.testo:2:1: note: previous declaration was here"* ]]
		"""

		exec bash """
			set +o pipefail
			set +e
			output=$(testo run /0005.testo 2>&1 > /dev/null)
			[[ $output == *"/0005.testo:6:1: Error: flash drive \\"A\\" is already defined"* ]]
			[[ $output == *"/0005.testo:2:1: note: previous declaration was here"* ]]
		"""

		exec bash """
			set +o pipefail
			set +e
			output=$(testo run /0006.testo 2>&1 > /dev/null)
			[[ $output == *"/0006.testo:6:1: Error: network \\"A\\" is already defined"* ]]
			[[ $output == *"/0006.testo:2:1: note: previous declaration was here"* ]]
		"""

		exec bash """
			set +o pipefail
			testo run /0007.testo 2>&1 > /dev/null | grep "/0007.testo:2:9: Error: can't specify test as a parent to itself A"
			testo run /0008.testo 2>&1 > /dev/null | grep '/0008.testo:2:9: Error: unknown test: B'
			testo run /0009.testo 2>&1 > /dev/null | grep '/0009.testo:6:12: Error: this test was already specified in parent list A'
			testo run /0010.testo 2>&1 > /dev/null | grep '/0010.testo:6:1: Error: virtual machine "A" is already defined here: /0010.testo:2:1'
		"""

		exec bash """
			set +o pipefail
			testo run /macro_call.testo --test_spec unknown_command_macro 2>&1 > /dev/null | grep "Error: unknown macro: some_macro"
			testo run /macro_call.testo --test_spec too_few_args_command 2>&1 > /dev/null | grep "Error: expected at least 2 args, 1 provided"
			testo run /macro_call.testo --test_spec too_many_args_command 2>&1 > /dev/null | grep "Error: expected at most 4 args, 5 provided"
			testo run /macro_call.testo --test_spec wrong_macro_0_command 2>&1 > /dev/null | grep "Error: duplicate macro arg: arg1"
			testo run /macro_call.testo --test_spec wrong_macro_1_command 2>&1 > /dev/null | grep "Error: default value must be specified for macro arg arg3"
			testo run /macro_call.testo --test_spec call_macro_action_outside_command 2>&1 > /dev/null | grep "Error: unexpected token \\\"print\\\", expected: }"
			testo run /macro_call.testo --test_spec call_macro_action_outside_command2 2>&1 > /dev/null | grep "Error: the \\\"my_macro\\\" macro does not contain commands, as expected"
			testo run /macro_call.testo --test_spec call_macro_command_inside_command 2>&1 > /dev/null | grep "Error: Unknown action: my_ubuntu_server"
			testo run /macro_call.testo --test_spec call_macro_command_inside_command2 2>&1 > /dev/null | grep "Error: the \\\"my_command_macro\\\" macro does not contain actions, as expected"
			testo run /macro_call.testo --test_spec call_nested_macro1 2>&1 > /dev/null | grep "Error: Unknown action: my_ubuntu_server"
			testo run /macro_call.testo --test_spec call_nested_macro2 2>&1 > /dev/null | grep "Error: unexpected token \\\"print\\\", expected: }"
			testo run /macro_call.testo --test_spec call_macro_starts_with_if 2>&1 > /dev/null | grep "Error: unexpected token \\\"if\\\", expected: }"
			testo run /macro_call.testo --test_spec call_macro_starts_with_for 2>&1 > /dev/null | grep "Error: unexpected token \\\"for\\\", expected: }"
			testo run /macro_call.testo --test_spec call_macro_starts_with_semicolon 2>&1 > /dev/null | grep "Error: unexpected token \\\";\\\", expected: }"
			testo run /macro_call.testo --test_spec wrong_flash_macro2 2>&1 > /dev/null | grep "Error: The action \\\"type\\\" is not applicable to a flash drive"
			testo run /macro_call.testo --test_spec call_macro_test_outside_test1 2>&1 > /dev/null |  grep "Error: unexpected token \\\"test\\\", expected: }"
		"""

		exec bash """
			set +o pipefail
			set +e
			output=$(testo run /macro_call.testo --test_spec call_macro_inside_if_check1)
			[[ $output == *"Hello world1"* ]]
			[[ $output != *"Hello world2"* ]]
		"""

		exec bash """
			set +o pipefail
			set +e
			output=$(testo run /macro_call.testo --test_spec call_macro_inside_if_check2)
			[[ $output != *"Hello world1"* ]]
			[[ $output == *"Hello world2"* ]]
		"""

		exec bash """
			set +o pipefail
			testo run /expr.testo --test_spec comparison_0 2>&1 > /dev/null | grep "Error: \\\"lala\\\" is not an integer number"
			testo run /expr.testo --test_spec comparison_1 2>&1 > /dev/null | grep "Error: \\\"lala\\\" is not an integer number"
			testo run /expr.testo --test_spec comparison_2 2>&1 > /dev/null | grep "Error: \\\"30ms\\\" is not an integer number"
			testo run /expr.testo --test_spec comparison_3 2>&1 > /dev/null | grep "Error: \\\"-5ms\\\" is not an integer number"
			testo run /expr.testo --test_spec comparison_4 2>&1 > /dev/null | grep "Error: \\\"Русский\\\" is not an integer number"
			testo run /expr.testo --test_spec comparison_5 2>&1 > /dev/null | grep "Error: \\\"- 5ms\\\" is not an integer number"
			testo run /expr.testo --test_spec check_flash 2>&1 > /dev/null | grep "Error: The \\\"check\\\" expression is not applicable to a flash drive"
		"""

		exec bash """
			set +o pipefail
			testo run /misc.testo --test_spec empty_wait_text 2>&1 > /dev/null | grep "Error: empty string in text selection"
			testo run /misc.testo --test_spec empty_mouse_move_text 2>&1 > /dev/null | grep "Error: empty string in text selection"
			testo run /misc.testo --test_spec empty_wait_js 2>&1 > /dev/null | grep "Error: empty script in js selection"
			testo run /misc.testo --test_spec empty_mouse_move_js 2>&1 > /dev/null | grep "Error: empty script in js selection"
			testo run /misc.testo --test_spec invalid_mouse_parented_expr_0 2>&1 > /dev/null | grep "Error: select expressions are not supported for mouse move/click actions"
			testo run /misc.testo --test_spec invalid_mouse_parented_expr_1 2>&1 > /dev/null | grep "Error: negation is not supported for mouse move/click actions"
			testo run /misc.testo --test_spec invalid_key_0 2>&1 > /dev/null | grep "Error: unknown key: SomeButton"
			testo run /misc.testo --test_spec invalid_key_1 2>&1 > /dev/null | grep "Error: duplicate key: LeftShift"
			testo run /misc.testo --test_spec invalid_press_times_0 2>&1 > /dev/null | grep "Error: can't press a button less than 1 time: 0"
			testo run /misc.testo --test_spec invalid_press_times_1 2>&1 > /dev/null | grep "Error: can't press a button less than 1 time: -1"
			testo run /misc.testo --test_spec invalid_press_times_2 2>&1 > /dev/null | grep "Error: can't press a button less than 1 time: -1"
			testo run /misc.testo --test_spec unknown_flash_0 2>&1 > /dev/null | grep "Error: unknown flash drive: unexisting_flash"
			testo run /misc.testo --test_spec unknown_flash_1 2>&1 > /dev/null | grep "Error: unknown flash drive: unexisting_flash"
			testo run /misc.testo --test_spec unknown_vm 2>&1 > /dev/null | grep "Error: unknown virtual entity: some_vm"
			testo run /misc.testo --test_spec common_vm_child 2>&1 > /dev/null | grep "Error: some parents have common virtual machines"
			testo run /misc.testo --test_spec common_flash_child 2>&1 > /dev/null | grep "Error: some parents have common flash drives"
			testo run /misc.testo --test_spec copyfrom_nocheck 2>&1 > /dev/null | grep "Error: \\\"nocheck\\\" specifier is not applicable to copyfrom action"
			testo run /misc.testo --test_spec copyto_from_not_exist 2>&1 > /dev/null | grep "Error: specified path doesn't exist: /some/unexisting_shit"
			testo run /misc.testo --test_spec flash_copyto_from_not_exist 2>&1 > /dev/null | grep "Error: specified path doesn't exist: /some/unexisting_shit"
			testo run /misc.testo --test_spec img_doesnt_exist1 2>&1 > /dev/null | grep "Error: specified image path does not exist: /someshit"
			testo run /misc.testo --test_spec img_doesnt_exist2 2>&1 > /dev/null | grep "Error: specified image path does not exist: /./someshit"
			testo run /misc.testo --test_spec img_doesnt_lead_to_a_file 2>&1 > /dev/null | grep "Error: specified image path does not lead to a regular file: /usr/sbin"
			testo run /misc.testo --test_spec invalid_hostdev_usb_addr1 2>&1 > /dev/null | grep "Error: spicified usb addr is not valid"
			testo run /misc.testo --test_spec invalid_hostdev_usb_addr2 2>&1 > /dev/null | grep "Error: spicified usb addr is not valid"
			testo run /misc.testo --test_spec invalid_hostdev_usb_addr3 2>&1 > /dev/null | grep "Error: spicified usb addr is not valid"
			testo run /misc.testo --test_spec invalid_hostdev_usb_addr4 2>&1 > /dev/null | grep "Error: spicified usb addr is not valid"
			testo run /misc.testo --test_spec invalid_hostdev_usb_addr5 2>&1 > /dev/null | grep "Error: spicified usb addr is not valid"
			testo run /misc.testo --test_spec invalid_hostdev_usb_addr6 2>&1 > /dev/null | grep "Error: spicified usb addr is not valid"
		"""

		exec bash """
			set +o pipefail
			testo run /mouse_specificators.testo --test_spec from_0 2>&1 > /dev/null | grep "Error: specifier from_top requires a non-negative number as an argument"
			testo run /mouse_specificators.testo --test_spec from_1 2>&1 > /dev/null | grep "Error: specifier from_left requires a non-negative number as an argument"
			testo run /mouse_specificators.testo --test_spec from_2 2>&1 > /dev/null | grep "Error: you can\'t use specifier from_top after another \\\"from\\\" specifier"
			testo run /mouse_specificators.testo --test_spec from_3 2>&1 > /dev/null | grep "Error: you can\'t use specifier from_top after a \\\"precision\\\" specifier"
			testo run /mouse_specificators.testo --test_spec from_4 2>&1 > /dev/null | grep "Error: you can\'t use specifier from_left after a \\\"move\\\" specifier"
			testo run /mouse_specificators.testo --test_spec centering_0 2>&1 > /dev/null | grep "Error: specifier center must not have an argument"
			testo run /mouse_specificators.testo --test_spec centering_1 2>&1 > /dev/null | grep "Error: you can\'t use specifier right_top after another \\\"precision\\\" specifier"
			testo run /mouse_specificators.testo --test_spec centering_2 2>&1 > /dev/null | grep "Error: you can\'t use specifier right_center after a \\\"move\\\" specifier"
			testo run /mouse_specificators.testo --test_spec move_0 2>&1 > /dev/null | grep "Error: specifier move_right requires a non-negative number as an argument"
			testo run /mouse_specificators.testo --test_spec move_1 2>&1 > /dev/null | grep "Error: specifier move_right requires a non-negative number as an argument"
			testo run /mouse_specificators.testo --test_spec unknown 2>&1 > /dev/null | grep "Error: unknown specifier: move_bottom"
			testo run /mouse_specificators.testo --test_spec js_with_specificators 2>&1 > /dev/null | grep "Error: mouse specifiers are not supported for js selections"
		"""

		exec bash """
			set +o pipefail
			testo run /macro_call.testo --test_spec unknown_macro 2>&1 > /dev/null | grep "Error: unknown macro: some_macro"
			testo run /macro_call.testo --test_spec too_few_args 2>&1 > /dev/null | grep "Error: expected at least 2 args, 1 provided"
			testo run /macro_call.testo --test_spec too_many_args 2>&1 > /dev/null | grep "Error: expected at most 4 args, 5 provided"
			testo run /macro_call.testo --test_spec wrong_macro_0 2>&1 > /dev/null | grep "Error: duplicate macro arg: arg1"
			testo run /macro_call.testo --test_spec wrong_macro_1 2>&1 > /dev/null | grep "Error: default value must be specified for macro arg arg3"
			testo run /macro_call.testo --test_spec wrong_flash_macro 2>&1 > /dev/null | grep "Error: The action \\\"type\\\" is not applicable to a flash drive"
		"""

		exec bash """
			set +o pipefail
			testo run /for.testo --test_spec wrong_r1_0 2>&1 > /dev/null | grep "Can't convert string value \\\"30ms\\\" to NUMBER"
			testo run /for.testo --test_spec wrong_r1_1 2>&1 > /dev/null | grep "Can't convert range start -5 to a non-negative number"
			testo run /for.testo --test_spec wrong_r1_2 2>&1 > /dev/null | grep "Can't convert range start -5 to a non-negative number"
			testo run /for.testo --test_spec wrong_r2_0 2>&1 > /dev/null | grep "Can't convert string value \\\"30ms\\\" to NUMBER"
			testo run /for.testo --test_spec wrong_r2_1 2>&1 > /dev/null | grep "Can't convert range finish -5 to a non-negative number"
			testo run /for.testo --test_spec wrong_r2_2 2>&1 > /dev/null | grep "Can't convert string value \\\"30ms\\\" to NUMBER"
			testo run /for.testo --test_spec wrong_r2_3 2>&1 > /dev/null | grep "Can't convert range finish -5 to a non-negative number"
			testo run /for.testo --test_spec wrong_r2_4 2>&1 > /dev/null | grep "Can't convert range finish -5 to a non-negative number"
			testo run /for.testo --test_spec wrong_start_finish_0 2>&1 > /dev/null | grep "Error: start of the range 5 is greater or equal to finish 4"
			testo run /for.testo --test_spec wrong_start_finish_1 2>&1 > /dev/null | grep "Error: start of the range 0 is greater or equal to finish 0"
		"""

		#multiline attributes
		exec bash """
			set +o pipefail
			testo run /0025.testo 2>&1 > /dev/null | grep "Can't accept multiline as an attr value"
		"""

		# check exit code
		exec bash """
			set +e
			testo run /misc.testo --test_spec empty_wait_text
			if [ $? -ne 2 ]
			then
				echo $?; exit 1;
			fi
		"""
	}
}

[no_snapshots: true]
test centos_semantic_macro_tests: centos_install_testo {
	centos {
		copyto "${TEST_ASSETS_DIR}/semantic" "/opt/scripts/semantic"

		exec bash "cp /opt/scripts/semantic/* /"

		exec bash """
			set +o pipefail
			set +e
			output=$(testo run /0011.testo 2>&1 > /dev/null)
			[[ $output == *"In a macro call A"* ]]
			[[ $output == *"Error: nested macro declarations are not supported"* ]]
		"""

		exec bash """
			set +o pipefail
			set +e
			output=$(testo run /0012.testo 2>&1 > /dev/null)
			[[ $output == *"In a macro call A"* ]]
			[[ $output == *"Error: param declaration inside macros is not supported"* ]]
		"""

		exec bash """
			set +o pipefail
			set +e
			output=$(testo run /0013.testo 2>&1 > /dev/null)
			[[ $output == *"In a macro call B"* ]]
			[[ $output == *"Error: test \\\\"VM1\\\\" is already defined*" ]]
			[[ $output == *"In a macro call A"* ]]
			[[ $output == *"note: previous declaration was here"* ]]
		"""

		exec bash """
			set +o pipefail
			set +e
			output=$(testo run /0014.testo 2>&1 > /dev/null)
			[[ $output == *"In a macro call B"* ]]
			[[ $output == *"Error: virtual machine \\\\"VM1\\\\" is already defined*" ]]
			[[ $output == *"In a macro call A"* ]]
			[[ $output == *"note: previous declaration was here"* ]]
		"""

		exec bash """
			set +o pipefail
			set +e
			output=$(testo run /0015.testo 2>&1 > /dev/null)
			[[ $output == *"In a macro call B"* ]]
			[[ $output == *"Error: flash drive \\\\"VM1\\\\" is already defined*" ]]
			[[ $output == *"In a macro call A"* ]]
			[[ $output == *"note: previous declaration was here"* ]]
		"""

		exec bash """
			set +o pipefail
			set +e
			output=$(testo run /0016.testo 2>&1 > /dev/null)
			[[ $output == *"In a macro call B"* ]]
			[[ $output == *"Error: network \\\\"VM1\\\\" is already defined*" ]]
			[[ $output == *"In a macro call A"* ]]
			[[ $output == *"note: previous declaration was here"* ]]
		"""

		exec bash """
			set +o pipefail
			testo run /0017.testo 2>&1 > /dev/null | grep "Error: unknown macro: A"
			testo run /0018.testo 2>&1 > /dev/null | grep "Error: expected at least 2 args, 1 provided"
			testo run /0019.testo 2>&1 > /dev/null | grep "Error: expected at most 4 args, 5 provided"
			testo run /0020.testo 2>&1 > /dev/null | grep "Error: duplicate macro arg: arg1"
			testo run /0021.testo 2>&1 > /dev/null | grep "Error: default value must be specified for macro arg arg3"
			testo run /0022.testo 2>&1 > /dev/null | grep "Error: unexpected token \\\"my_ubuntu_server\\\", expected: }"
			testo run /0023.testo 2>&1 > /dev/null | grep "Error: unexpected token \\\"my_ubuntu_server\\\", expected: }"
			testo run /0024.testo 2>&1 > /dev/null | grep "Error: the \\\"test_macro\\\" macro does not contain commands, as expected"
		"""
	}
}
