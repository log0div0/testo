include "centos.testo"

[no_snapshots: true]
test centos_vm_create: centos_prepare_testo {
	centos {
		copyto "${TEST_ASSETS_DIR}/vm_creation/vm_create.testo" "/opt/scripts/vm_create.testo"
		exec bash """
			set +o pipefail
			testo run /opt/scripts/vm_create.testo --test_spec create_vm_no_cpus 2>&1 > /dev/null | grep "Constructing QemuVM \\\"vm_no_cpus\\\" error: field \\\"cpu\\\" is not specified"
			testo run /opt/scripts/vm_create.testo --test_spec create_vm_no_ram 2>&1 > /dev/null | grep "Constructing QemuVM \\\"vm_no_ram\\\" error: field \\\"ram\\\" is not specified"
			testo run /opt/scripts/vm_create.testo --test_spec create_vm_no_disk 2>&1 > /dev/null | grep "Constructing QemuVM \\\"vm_no_disk\\\" error: you must specify at least 1 disk"
			testo run /opt/scripts/vm_create.testo --test_spec create_vm_too_many_disks 2>&1 > /dev/null | grep "Constructing QemuVM \\\"vm_too_many_disks\\\" error: too many disks specified, maximum amount: 3"
			testo run /opt/scripts/vm_create.testo --test_spec create_vm_disk_no_size 2>&1 > /dev/null | grep "Constructing QemuVM \\\"vm_disk_no_size\\\" error: either field \\\"size\\\" or \\\"source\\\" must be specified for the disk \\\"main\\\""
			testo run /opt/scripts/vm_create.testo --test_spec create_vm_identical_disks 2>&1 > /dev/null | grep "Constructing QemuVM \\\"vm_identical_disks\\\" error: two identical disk names: \\\"first\\\""
			testo run /opt/scripts/vm_create.testo --test_spec create_vm_nic_no_attached_to 2>&1 > /dev/null | grep "Constructing QemuVM \\\"vm_nic_no_attached_to\\\" error: field attached_to is not specified for the nic \\\"my_nic\\\""
			testo run /opt/scripts/vm_create.testo --test_spec create_vm_nic_incorrect_mac 2>&1 > /dev/null | grep "Constructing QemuVM \\\"vm_nic_incorrect_mac\\\" error: incorrect mac string: \\\"AA:BB:CC:DD:EE:FF:AA\\\""
			testo run /opt/scripts/vm_create.testo --test_spec create_vm_nic_incorrect_type 2>&1 > /dev/null | grep "Constructing QemuVM \\\"vm_nic_incorrect_type\\\" error: nic \\\"my_nic\\\" has unsupported adapter type: \\\"some_type\\\""
			testo run /opt/scripts/vm_create.testo --test_spec create_vm_identical_nic_names 2>&1 > /dev/null | grep "Constructing QemuVM \\\"vm_identical_nic_names\\\" error: two identical NIC names: \\\"my_nic\\\""
			testo run /opt/scripts/vm_create.testo --test_spec create_vm_iso_does_not_exist 2>&1 > /dev/null | grep "Can't construct VmController for vm \\\"vm_iso_does_not_exist\\\": target iso file \\\"/opt/some_iso.iso\\\" does not exist"
			testo run /opt/scripts/vm_create.testo --test_spec create_vm_iso_does_not_exist_1 2>&1 > /dev/null | grep "Can't construct VmController for vm \\\"vm_iso_does_not_exist_1\\\": target iso file \\\"/opt/scripts/../some_iso.iso\\\" does not exist"
			testo run /opt/scripts/vm_create.testo --test_spec create_vm_image_does_not_exist 2>&1 > /dev/null | grep "Can't construct VmController for vm \\\"vm_image_does_not_exist\\\": source disk image \\\"/opt/some_image.img\\\" does not exist"
			testo run /opt/scripts/vm_create.testo --test_spec create_vm_image_does_not_exist_1 2>&1 > /dev/null | grep "Can't construct VmController for vm \\\"vm_image_does_not_exist_1\\\": source disk image \\\"/opt/scripts/../some_image.img\\\" does not exist"
			testo run /opt/scripts/vm_create.testo --test_spec create_vm_unknown_network 2>&1 > /dev/null | grep "Can't construct VmController for vm \\\"vm_unknown_network\\\": nic \\\"my_nic\\\" is attached to an unknown network: \\\"some_network\\\""
			testo run /opt/scripts/vm_create.testo --test_spec create_vm_unknown_attr 2>&1 > /dev/null | grep "Error: unknown attribute name: \\\"some_attr\\\""
			testo run /opt/scripts/vm_create.testo --test_spec create_vm_attr_requires_name 2>&1 > /dev/null | grep "Error: attribute \\\"disk\\\" requires a name"
			testo run /opt/scripts/vm_create.testo --test_spec create_vm_attr_must_have_no_name 2>&1 > /dev/null | grep "Error: attribute \\\"ram\\\" must have no name"
			testo run /opt/scripts/vm_create.testo --test_spec create_vm_attr_type_mismatch 2>&1 > /dev/null | grep "Error: unexpected value type \\\"QUOTED STRING\\\" for attribute \\\"size\\\", expected \\\"SIZE\\\""
			testo run /opt/scripts/vm_create.testo --test_spec create_vm_attr_diplucates 2>&1 > /dev/null | grep "Error: duplicate attribute: \\\"cpus\\\""
			testo run /opt/scripts/vm_create.testo --test_spec create_vm_negative_attribute 2>&1 > /dev/null | grep "Error: numeric attr can't be negative: -7"
		""" timeout 30m
	}
}


test centos_backend_qemu_create_simple_vm: centos_prepare_testo {
	centos {
		copyto "${TEST_ASSETS_DIR}/vm_creation/vm_create.testo" "/opt/scripts/vm_create.testo"
		exec bash """
			testo run /opt/scripts/vm_create.testo --stop_on_fail --test_spec create_basic_vm
		""" timeout 30m

		wait "basic_machine"
	}
}


[no_snapshots: true]
test centos_backend_qemu_create_vm_after_manual_delete_no_disks: centos_backend_qemu_create_simple_vm {
	centos {
		mouse rclick "basic_machine";
		mouse click "Delete"
		mouse click "Delete associated storage files"
		wait !"hda"
		mouse click "Delete".from_bottom(0)

		exec bash """
			testo run /opt/scripts/vm_create.testo --stop_on_fail --test_spec create_basic_vm
		""" timeout 30m

		wait "basic_machine"
	}
}

[no_snapshots: true]
test centos_backend_qemu_clean_after_manual_delete_no_disks: centos_backend_qemu_create_simple_vm {
	centos {
		mouse rclick "basic_machine";
		mouse click "Delete"
		mouse click "Delete associated storage files"
		wait !"hda"
		mouse click "Delete".from_bottom(0)

		exec bash """
			testo clean --assume_yes | grep 'Deleted virtual machine basic_machine'
		""" timeout 30m

		exec bash "!([ -f /var/lib/libvirt/testo/testo-storage-pool/basic_machine@main.img ])"
	}
}

[no_snapshots: true]
test centos_backend_qemu_meta_version0_vm_recovery: centos_backend_qemu_create_simple_vm {
	centos {
		exec python3 """
			import json

			with open('/var/lib/libvirt/testo/vm_metadata/basic_machine/basic_machine__init') as data_file:
			    data = json.load(data_file)

			del data['opaque']

			with open('/var/lib/libvirt/testo/vm_metadata/basic_machine/basic_machine__init', 'w') as data_file:
			    data = json.dump(data, data_file)
		"""

		exec bash """
			testo run /opt/scripts/vm_create.testo --test_spec create_basic_vm | grep "Creating virtual machine basic_machine"
		""" timeout 30m

	}
}

[no_snapshots: true]
test centos_backend_qemu_meta_version1_vm_recovery: centos_backend_qemu_create_simple_vm {
	centos {
		exec python3 """
			import json

			with open('/var/lib/libvirt/testo/vm_metadata/basic_machine/basic_machine__init') as data_file:
			    data = json.load(data_file)

			del data['metadata_version']

			with open('/var/lib/libvirt/testo/vm_metadata/basic_machine/basic_machine__init', 'w') as data_file:
			    data = json.dump(data, data_file)
		"""

		exec bash """
			testo run /opt/scripts/vm_create.testo --test_spec create_basic_vm | grep "Creating virtual machine basic_machine"
		""" timeout 30m

	}
}
