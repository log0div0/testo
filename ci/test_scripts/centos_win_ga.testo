
include "centos.testo"

flash win7_flash {
	fs: "ext4"
	size: 5Gb
}

flash win10_flash {
	fs: "ext4"
	size: 6Gb
}

test centos_qemu_ga_win7_x86_install: centos_prepare_testo {
	win7_flash {
		copyto "${ISO_DIR}/win7.iso" "/win7.iso"
	}
	centos {
		copyto "${TEST_ASSETS_DIR}/win_ga/win7_x86_install.testo" "/opt/scripts/win7_install.testo"
		plug flash win7_flash
		sleep 5s
		exec bash "cp /run/media/user/*/win7.iso /opt/"
		exec bash "umount /run/media/user/*"
		sleep 5s
		unplug flash win7_flash

		exec bash "testo run /opt/scripts/win7_install.testo --stop_on_fail --param ISO_DIR /opt/" timeout 1h
	}
}

[no_snapshots: true]
test centos_qemu_ga_win7_x86_tests: centos_qemu_ga_win7_x86_install {
	centos {
		copyto "${TEST_ASSETS_DIR}/win_ga/win7_tests.testo" "/opt/scripts/win7_tests.testo"
		copyto "${OUT_DIR}/testo-guest-additions.iso" "/opt/testo-guest-additions.iso"
		exec bash "echo \"Hello world!\" > \"/opt/scripts/привет, мир!.txt\""
		exec bash "testo run /opt/scripts/win7_tests.testo --stop_on_fail --param ISO_DIR /opt/" timeout 20m
	}
}

test centos_qemu_ga_win7_x64_install: centos_prepare_testo {
	win7_flash {
		copyto "${ISO_DIR}/win7.iso" "/win7.iso"
	}
	centos {
		copyto "${TEST_ASSETS_DIR}/win_ga/win7_x64_install.testo" "/opt/scripts/win7_install.testo"
		plug flash win7_flash
		sleep 5s
		exec bash "cp /run/media/user/*/win7.iso /opt/"
		exec bash "umount /run/media/user/*"
		sleep 5s
		unplug flash win7_flash

		exec bash "testo run /opt/scripts/win7_install.testo --stop_on_fail --param ISO_DIR /opt/" timeout 1h
	}
}

[no_snapshots: true]
test centos_qemu_ga_win7_x64_tests: centos_qemu_ga_win7_x64_install {
	centos {
		copyto "${TEST_ASSETS_DIR}/win_ga/win7_tests.testo" "/opt/scripts/win7_tests.testo"
		copyto "${OUT_DIR}/testo-guest-additions.iso" "/opt/testo-guest-additions.iso"
		exec bash "echo \"Hello world!\" > \"/opt/scripts/привет, мир!.txt\""
		exec bash "testo run /opt/scripts/win7_tests.testo --stop_on_fail --param ISO_DIR /opt/" timeout 20m
	}
}

test centos_qemu_ga_win10_install: centos_prepare_testo {
	win10_flash {
		copyto "${ISO_DIR}/win10.iso" "/win10.iso"
	}
	centos {
		copyto "${TEST_ASSETS_DIR}/win_ga/win10_install.testo" "/opt/scripts/win10_install.testo"
		plug flash win10_flash
		sleep 5s
		exec bash "cp /run/media/user/*/win10.iso /opt/"
		exec bash "umount /run/media/user/*"
		sleep 5s
		unplug flash win10_flash

		exec bash "testo run /opt/scripts/win10_install.testo --stop_on_fail --param ISO_DIR /opt/" timeout 1h
	}
}

[no_snapshots: true]
test centos_qemu_ga_win10_tests: centos_qemu_ga_win10_install {
	centos {
		copyto "${TEST_ASSETS_DIR}/win_ga/win10_tests.testo" "/opt/scripts/win10_tests.testo"
		copyto "${OUT_DIR}/testo-guest-additions.iso" "/opt/testo-guest-additions.iso"
		exec bash "testo run /opt/scripts/win10_tests.testo --stop_on_fail --param ISO_DIR /opt/" timeout 20m
	}
}
