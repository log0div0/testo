..  SPDX-License-Identifier: BSD-3-Clause
    Copyright(c) 2010-2014 Intel Corporation.

.. _flash:

flash
=====

Для объявления виртуальных флеш-накопителей используется директива ``flash``. Формат директивы выглядит следующим образом:

.. code-block:: none

	flash <name> {
		<attr1: <value1>
		<attr2: <value1>
		<attr3: <value1>
		...
	}

.. note::
	Объявление виртуального флеш-накопителя само по себе не ведет к его созданию. Реальное создание произойдет при запуске теста, в котором учавствует этот флеш-накопитель.


Витруальные флеш-накопители могут использоваться в командах ``(un)plug flash`` для того, чтобы организовать передачу данных между машинами, имитируя реальные флеш-накопители, которые могут использовать люди.

Виртуальный флеш-накопитель, как и виртуальная машина, требует наличия уникального среди флеш-накопителей имени ``name``.

Объявление виртуальных флеш-накопителей во многом схоже с :ref:`объявлением виртуальных машин <machine>`, но список атрибутов здесь другой:

	*  ``fs`` - тип файловой системы, которая будет использоваться в флеш-накопителе. В настоящий момент поддерживается только значение ``"ntfs"``
	*  ``size`` - размер флешки. Значение аттрибута должно быть **спецификатором количества памяти**.
	*  ``folder`` - путь к папке в хостовой машине, которую необходимо скопировать на флешку при ее создании. Необязательный атрибут. Значение аттрибута должно быть **строкой**. Если в строке присутствует обращение к переменной, то ее значение будет взято из переменной окружения.

Ниже представлен пример объявления флеш-накопителя.

.. code-block:: none

	flash example_flash {
		fs: "ntfs"
		size: 32Mb
		folder: "./some_folder"
	}

.. warning::
    Для использования виртуальных флеш-накопителей необходимо загрузить модуль ядра ``nbd`` с параметром ``max_parts=1``. Сделать это можно командой ``sudo modprobe nbd max_parts=1``


Кешируемость виртуальных флеш-накопителей
-----------------------------------------

В платформе Testo предусмотрен механизм определения актуальности конфигурации флеш-накопителей. Если с момента последнего запуска конфигурация флеш-накопителя существенно изменилась, то флеш-накопитель необходимо пересоздать, а все тесты, в которых он учавствует - прогнать заново. Это одна из проверок, которая определяет :ref:`актуальность кеша теста <test_cksum>`.

Ниже приведен список вопросов, которые платформа Testo считает существенными при определении закешированности конфигурации виртуального флеш-накопителя

	- Изменилось ли значение атрибутов ``fs``, ``size``?
	- Изменились ли содержимое папки, указанной в атрибуте ``folder``?

Если ответ на хотя бы один из этих вопросов - положительный, то кеш считается неактуальным и флеш-накопитель необходимо создать заново.

.. note ::
	На кеш не влияет изменение строки, указанной в атрибуте ``folder``. Проверка осуществляется исключительно по фактическому содержимому папки
