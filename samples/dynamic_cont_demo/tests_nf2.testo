include "installations.testo"

[
	description: "TESTCASE 89624[NF2]: Проверка загрузки и валидации конфигурации bird"
	no_snapshots: true
]
test validate_bird_config_nf2: UB_install_nf2 {
	MS {
		copyto "bird_configs/bgp_big_test.conf" "C:\\Users\\testo\\Desktop\\bgp_big_test.conf"

		mouse click "Структура"
		mouse click "node-${UB1_id}"
		sleep 2s
		mouse click "Свойства".from_top(0)
		wait "безопасности - node-${UB1_id}"

		mouse click "Динамические маршруты"
		mouse move 0 0
		mouse click "Динамические маршруты".from_left(1)

		mouse click "Конфигурация маршрутизации".right_center().move_right(240)
		mouse click "Рабочий стол"
		mouse click "Имя файла:".right_center().move_right(30)
		type "bgp_big_test.conf"
		mouse click "Открыть".from_bottom(0)
		mouse click "Применить".from_bottom(0)

		if (check "Ошибка сервера" timeout 5s) {
			abort "valid bird has been rejected"
		}

		mouse click "else reject;"; press End, Backspace
		mouse click "Применить".from_bottom(0)
		
		wait "syntax error, unexpected '}"; press Enter

		mouse click "protocol kernel"; press Home, Delete
		mouse click "Применить".from_bottom(0)
		
		wait "CF_SYM_UNDEFINED"; press Enter

		mouse click "Конфигурация маршрутизации".right_center().move_right(240)
		mouse click "Имя файла:".right_center().move_right(30)
		type "bgp_big_test.conf"
		mouse click "Открыть".from_bottom(0)
		mouse click "Применить".from_bottom(0)
		sleep 5s
		plug flash bird_flash
		mouse click "Конфигурация маршрутизации".right_center().move_right(270)

		wait "Сохранить как"
		mouse click "Компьютер".from_left(0)
		mouse dclick "Локальный диск (Е:)"
		mouse click "Сохранить".from_bottom(0)

		safe_umount()

		unplug flash bird_flash

		mouse click "Конфигурация маршрутизации"
		press LeftAlt + F4

		mouse click "Установить"

		wait "Установить политики"
		sleep 3s
		press Enter

		wait "Установка политики на узлы безопасности"
		wait "Новых уведомлений нет" timeout 3m
	}

	UB1 {
		wait "root@node-${UB1_id}"

		plug flash bird_flash
		type "service bird-nf2 status"; press Enter
		wait "Выполняется"

		type "mount /dev/sdb1 /media"; press Enter
		type "cp /media/routes.conf /tmp/"; press Enter
		type "umount /media"; press Enter
		sleep 3s
		unplug flash bird_flash

		type "cmp /tmp/routes.conf /etc/bird-nf2.conf && echo result is $?"; press Enter
		wait "result is 0"
	}
}

[
description: "TESTCASE 88373[NF2]: Проверка работы 2 OSPF процесса на УБ"
no_snapshots: true
]
test ospf_2_processes_nf2: UB_install_nf2, router3_prepare, LAN2_ARM_prepare, LAN3_ARM_prepare {
	router1 {
		copyto "bird_configs/OSPF_R1.conf" "/opt/OSPF_R1.conf"
		exec bash "bird -c /opt/OSPF_R1.conf"
	}

	router3 {
		copyto "bird_configs/OSPF_R3.conf" "/opt/OSPF_R3.conf"
		exec bash "bird -c /opt/OSPF_R3.conf"
	}

	MS {
		mouse rclick "node-${UB1_id}"
		mouse click "Свойства".from_bottom(0)
		wait "безопасности - node-${UB1_id}"

		mouse click "Динамические маршруты"
		mouse move 0 0
		mouse click "Динамические маршруты".from_left(1)

		copyto "bird_configs/2_OSPF_UB1.conf" "C:\\Users\\testo\\Desktop\\2_OSPF_UB1.conf"

		mouse click "Конфигурация маршрутизации".right_center().move_right(240)
		mouse click "Рабочий стол"
		mouse click "Имя файла:".right_center().move_right(30)
		type "2_OSPF_UB1.conf"
		mouse click "Открыть".from_bottom(0)

		mouse click "Интерфейсы"
		#ge-0-0, OSPF1_side
		mouse dclick "Не определён".from_top(0)
		wait "Назначение:"
		mouse click "Не определён";
		mouse click "Внешний"
		mouse click "Разрешенные протоколы:".right_center().move_right(30)
		mouse click "OSPF"; press Space, Enter*2
		wait !"Назначение:"
		sleep 2s

		mouse dclick "Не определён".from_top(0)
		wait "Назначение:"
		mouse click "Не определён";
		mouse click "Внешний"
		mouse click "Разрешенные протоколы:".right_center().move_right(30)
		mouse click "OSPF"; press Space, Enter*2
		wait !"Назначение:"
		sleep 2s

		mouse click "OK".from_bottom(0)

		mouse click "Установить"
		mouse click "Установить политики"
		sleep 3s
		press Enter

		wait "Установка политики на узлы безопасности"
		wait "Новых уведомлений нет" timeout 3m
	}

	UB1 {
		wait "root@node-${UB1_id}"
		type "birdc-nf2 show ospf neighbor ospf1"; press Enter
		wait "Full/PtP" && "ge-0-0" && js "find_text().match('${router1_OSPF1_ip}').size() == 2"
		type "clear"; press Enter
		type "birdc-nf2 show ospf neighbor ospf2"; press Enter
		wait "Full/PtP" && "ge-1-0" && js "find_text().match('${router3_OSPF2_ip}').size() == 2"
		type "clear"; press Enter

		type "birdc-nf2 show route protocol ospf1"; press Enter
		wait "${LAN1_ip}" && "${router1_Lo_ip}" && js "find_text().match('via ${router1_OSPF1_ip}').size() == 2"
		type "clear"; press Enter

		type "birdc-nf2 show route protocol ospf2"; press Enter
		wait "${LAN2_ip}" && "${router3_Lo_ip}" && js "find_text().match('via ${router3_OSPF2_ip}').size() == 2"
		type "clear"; press Enter
	}

	router1 {
		exec bash "ip r s | fgrep \"${LAN3_ip}/${default_netmask} via ${UB1_OSPF1_ip}\""
		exec bash "ip r s | fgrep \"${OSPF2_ip}/${default_netmask} via ${UB1_OSPF1_ip}\""
		exec bash "ip r s | fgrep \"${BGP1_ip}/${BGP_netmask} via ${UB1_OSPF1_ip}\""
		exec bash "ip r s | fgrep \"${UB1_Lo0_ip} via ${UB1_OSPF1_ip}\""
		exec bash "ip r s | fgrep \"${UB1_Lo1_ip} via ${UB1_OSPF1_ip}\""
	}

	router3 {
		exec bash "ip r s | fgrep \"${LAN3_ip}/${default_netmask} via ${UB1_OSPF2_ip}\""
		exec bash "ip r s | fgrep \"${OSPF1_ip}/${default_netmask} via ${UB1_OSPF2_ip}\""
		exec bash "ip r s | fgrep \"${BGP1_ip}/${BGP_netmask} via ${UB1_OSPF2_ip}\""
		exec bash "ip r s | fgrep \"${UB1_Lo0_ip} via ${UB1_OSPF2_ip}\""
		exec bash "ip r s | fgrep \"${UB1_Lo1_ip} via ${UB1_OSPF2_ip}\""
	}

	LAN2_ARM {
		exec bash "!(ping ${MS_ip} -c 5)"
		exec bash "ping ${LAN3_ARM_ip} -c 5"
	}

	MS {
		#exec cmd "ping ${LAN2_ARM_ip} && exit /b 1"
		exec cmd "ping ${LAN3_ARM_ip}"
	}

	router3 {
		unplug link OSPF2_side
		sleep 5s
		exec bash "!(ip r s | fgrep \"${LAN3_ip}/${default_netmask} via ${UB1_OSPF2_ip}\")"
		exec bash "!(ip r s | fgrep \"${OSPF1_ip}/${default_netmask} via ${UB1_OSPF2_ip}\")"
		exec bash "!(ip r s | fgrep \"${BGP1_ip}/${BGP_netmask} via ${UB1_OSPF2_ip}\")"
		exec bash "!(ip r s | fgrep \"${UB1_Lo0_ip} via ${UB1_OSPF2_ip}\")"
		exec bash "!(ip r s | fgrep \"${UB1_Lo1_ip} via ${UB1_OSPF2_ip}\")"
	}

	UB1 {
		type "ip r s"; press Enter
		wait !"${LAN2_ip}"
		type "clear"; press Enter
		type "birdc-nf2 show protocols ospf2"; press Enter
		wait "Alone"
		type "clear"; press Enter
	}

	router3 {
		plug link OSPF2_side
		sleep 10s
	}

	UB1 {
		type "ip r s"; press Enter
		wait "${LAN2_ip}"
		type "clear"; press Enter
		type "birdc-nf2 show protocols ospf1"; press Enter
		wait "Running"
		type "clear"; press Enter
	}

	router3 {
		exec bash "ip r s | fgrep \"${LAN3_ip}/${default_netmask} via ${UB1_OSPF2_ip}\""
		exec bash "ip r s | fgrep \"${OSPF1_ip}/${default_netmask} via ${UB1_OSPF2_ip}\""
		exec bash "ip r s | fgrep \"${BGP1_ip}/${BGP_netmask} via ${UB1_OSPF2_ip}\""
		exec bash "ip r s | fgrep \"${UB1_Lo0_ip} via ${UB1_OSPF2_ip}\""
		exec bash "ip r s | fgrep \"${UB1_Lo1_ip} via ${UB1_OSPF2_ip}\""
	}
}

[
description: "TESTCASE 88853 [NF2]: Проверка работы метрик протоколов OSPF и BGP"
no_snapshots: true
]
test ospf_ebgp_nf2: UB_install_nf2, LAN3_ARM_prepare, LAN5_ARM_prepare {
	router1 {
		copyto "bird_configs/OSPF_R1.conf" "/opt/OSPF_R1.conf"
		exec bash "bird -c /opt/OSPF_R1.conf"
	}

	router2 {
		copyto "bird_configs/OSPF+eBGP_R2.conf" "/opt/OSPF+eBGP_R2.conf"
		exec bash "bird -c /opt/OSPF+eBGP_R2.conf"
	}

	MS {
		mouse click "Структура"
		mouse rclick "node-${UB1_id}"
		mouse click "Свойства".from_bottom(0)
		wait "безопасности - node-${UB1_id}"

		mouse click "Динамические маршруты"
		mouse move 0 0
		mouse click "Динамические маршруты".from_left(1)

		copyto "bird_configs/OSPF+eBGP_UB1.conf" "C:\\Users\\testo\\Desktop\\OSPF+eBGP_UB1.conf"

		mouse click "Конфигурация маршрутизации".right_center().move_right(240)
		mouse click "Рабочий стол"
		mouse click "Имя файла:".right_center().move_right(30)
		type "OSPF+eBGP_UB1.conf"
		mouse click "Открыть".from_bottom(0)

		mouse click "Интерфейсы"
		#ge-0-0, OSPF1_side
		mouse dclick "Не определён".from_top(0)
		wait "Назначение:"
		mouse click "Не определён";
		mouse click "Внешний"
		mouse click "Разрешенные протоколы:".right_center().move_right(30)
		mouse click "OSPF"; press Space, Enter*2
		wait !"Назначение:"
		sleep 2s

		mouse dclick "Не определён".from_top(1)
		wait "Назначение:"
		mouse click "Не определён";
		mouse click "Внешний"
		mouse click "Разрешенные протоколы:".right_center().move_right(30)
		mouse click "BGP"; press Space, Enter*2
		wait !"Назначение:"
		sleep 2s
		mouse click "Анонсируемые адреса"
		press Enter

		mouse click "Установить"

		mouse click "Установить политики"
		sleep 3s
		press Enter
		wait "Установка политики на узлы безопасности"
		wait "Новых уведомлений нет" timeout 3m
	}

	UB1 {
		wait "root@node-${UB1_id}"

		sleep 10s

		type "birdc-nf2 show protocols"; press Enter
		wait "ospf1" && js "find_text().match('Running').size() == 1"
		wait "ebgp1" && js "find_text().match('Established').size() == 1"
		type "clear"; press Enter

		type "birdc-nf2 show route protocol ospf1"; press Enter

		wait "${LAN1_ip}/${default_netmask}"
		wait "${router1_Lo_ip}/${default_loopback_netmask}"
		wait js "find_text().match('via ${router1_OSPF1_ip} on ge-0-0').size() == 2"

		type "clear"; press Enter

		type "birdc-nf2 show route protocol ebgp1"; press Enter
		wait "${router2_Lo0_ip}/${default_loopback_netmask}"
		wait "${BGP2_ip}/${BGP_netmask}"
		wait "${LAN5_ip}/${default_netmask}"

		wait js "find_text().match('via ${router2_BGP1_ip} on ge-2-0').size() == 3"

		type "clear"; press Enter

		type "ip r s"; press Enter

		wait "${LAN1_ip}/${default_netmask} via ${router1_OSPF1_ip} dev ge-0-0 proto bird metric 110"
		wait "${router1_Lo_ip} via ${router1_OSPF1_ip} dev ge-0-0 proto bird metric 110"
		wait "${router2_Lo0_ip} via ${router2_BGP1_ip} dev ge-2-0 proto bird metric 20"
		wait "${BGP2_ip}/${BGP_netmask} via ${router2_BGP1_ip} dev ge-2-0 proto bird metric 20"
		wait "${LAN5_ip}/${default_netmask} via ${router2_BGP1_ip} dev ge-2-0 proto bird metric 20"
		type "clear"; press Enter
	}

	LAN5_ARM {
		exec bash "ping ${MS_ip} -c5"
		exec bash "ping ${router1_Lo_ip} -c5"
	}

	MS {
		exec cmd "ping ${LAN5_ARM_ip}"
	}

	router2 {
		unplug link BGP1_side
		sleep 10s
	}

	UB1 {
		type "birdc-nf2 show protocols"; press Enter
		wait !"Established"
		type "clear"; press Enter

		type "ip r s"; press Enter
		wait !"${router2_Lo0_ip} via ${router2_BGP1_ip} dev ge-2-0 proto bird metric 20"
		wait !"${BGP2_ip}/${BGP_netmask} via ${router2_BGP1_ip} dev ge-2-0 proto bird metric 20"
		wait !"${LAN5_ip}/${default_netmask} via ${router2_BGP1_ip} dev ge-2-0 proto bird metric 20"
		type "clear"; press Enter
	}

	router2 {
		plug link BGP1_side
		sleep 1m
	}

	UB1 {
		type "ip r s"; press Enter

		wait "${router2_Lo0_ip} via ${router2_BGP1_ip} dev ge-2-0 proto bird metric 20"
		wait "${BGP2_ip}/${BGP_netmask} via ${router2_BGP1_ip} dev ge-2-0 proto bird metric 20"
		wait "${LAN5_ip}/${default_netmask} via ${router2_BGP1_ip} dev ge-2-0 proto bird metric 20"
		type "clear"; press Enter
	}

	LAN5_ARM {
		exec bash "ping ${MS_ip} -c5"
		exec bash "ping ${router1_Lo_ip} -c5"
	}

	MS {
		exec cmd "ping ${LAN5_ARM_ip} -n 4"
	}
}


[
description: "TESTCASE 89109 [NF2]: Проверка редистрибуции маршрутов ospf и ibgp"
no_snapshots: true
]
test ospf_ibgp_nf2: UB_install_nf2, LAN4_ARM_prepare {
	router1 {
		copyto "bird_configs/OSPF_R1.conf" "/opt/OSPF_R1.conf"
		exec bash "bird -c /opt/OSPF_R1.conf"
	}

	router2 {
		copyto "bird_configs/OSPF+iBGP_R2.conf" "/opt/OSPF+iBGP_R2.conf"
		exec bash "bird -c /opt/OSPF+iBGP_R2.conf"
	}

	MS {
		mouse rclick "node-${UB1_id}"
		mouse click "Свойства".from_bottom(0)
		wait "безопасности - node-${UB1_id}"

		mouse click "Динамические маршруты"
		mouse move 0 0
		mouse click "Динамические маршруты".from_left(1)

		copyto "bird_configs/OSPF+iBGP_UB1.conf" "C:\\Users\\testo\\Desktop\\OSPF+iBGP_UB1.conf"

		mouse click "Конфигурация маршрутизации".right_center().move_right(240)
		mouse click "Рабочий стол"
		mouse click "Имя файла:".right_center().move_right(30)
		type "OSPF+iBGP_UB1.conf"
		mouse click "Открыть".from_bottom(0)

		mouse click "Интерфейсы"
		#ge-0-0, OSPF1_side
		mouse dclick "Не определён".from_top(0)
		wait "Назначение:"
		mouse click "Не определён";
		mouse click "Внешний"
		mouse click "Разрешенные протоколы:".right_center().move_right(30)
		mouse click "OSPF"; press Space, Enter*2
		wait !"Назначение:"
		sleep 2s

		mouse dclick "Не определён".from_top(1)
		wait "Назначение:"
		mouse click "Не определён";
		mouse click "Внешний"
		mouse click "Разрешенные протоколы:".right_center().move_right(30)
		mouse click "BGP"; press Space, Enter*2
		wait !"Назначение:"
		sleep 2s

		mouse click "OK".from_bottom(0)

		mouse rclick "node-${UB2_id}"
		mouse click "Свойства".from_bottom(0)
		wait "безопасности - node-${UB2_id}"

		mouse click "Динамические маршруты"
		mouse move 0 0
		mouse click "Динамические маршруты".from_left(1)

		copyto "bird_configs/OSPF+iBGP_UB2.conf" "C:\\Users\\testo\\Desktop\\OSPF+iBGP_UB2.conf"

		mouse click "Конфигурация маршрутизации".right_center().move_right(240)
		mouse click "Имя файла:".right_center().move_right(30)
		type "OSPF+iBGP_UB2.conf"
		mouse click "Открыть".from_bottom(0)

		mouse click "Интерфейсы"
		mouse dclick "Не определён".from_top(0)
		wait "Назначение:"
		mouse click "Не определён";
		mouse click "Внешний"
		mouse click "Разрешенные протоколы:".right_center().move_right(30)
		mouse click "BGP"; press Space, Enter*2
		wait !"Назначение:"
		sleep 2s
		mouse click "OK".from_bottom(0)
		mouse click "Установить"
		mouse click "Установить политики"
		sleep 3s
		press Enter
		wait "Установка политики на узлы безопасности"
		wait "Новых уведомлений нет" timeout 3m
	}

	UB1 {
		wait "root@node-${UB1_id}"

		type "birdc-nf2 show protocols"; press Enter
		wait "ibgp1" && "ibgp2" && js "find_text().match('Established').size() == 2"
		type "clear"; press Enter

		sleep 10s

		type "birdc-nf2 show route"; press Enter
		wait "${router1_Lo_ip}/${default_loopback_netmask}" && "${UB2_Lo0_ip}/${default_loopback_netmask}" && "${UB2_Lo1_ip}/${default_loopback_netmask}"

		type "clear"; press Enter
		type "ip r s"; press Enter

		wait "${router1_Lo_ip} via ${router1_OSPF1_ip} dev ge-0-0 proto bird metric 110"
		wait "${UB2_Lo0_ip} via ${router2_BGP1_ip} dev ge-2-0"
		wait "${UB2_Lo1_ip} via ${router2_BGP1_ip} dev ge-2-0 proto bird metric 200"

		type "clear"; press Enter
	}

	UB2 {
		wait "root@node-${UB2_id}"

		type "birdc-nf2 show protocols"; press Enter
		wait "ibgp1" && "ibgp2" && js "find_text().match('Established').size() == 2"
		type "clear"; press Enter

		type "birdc-nf2 show route"; press Enter

		wait "${router1_Lo_ip}/${default_loopback_netmask}" && "${LAN1_ip}/${default_netmask}" && "${BGP1_ip}/${BGP_netmask}" && "${BGP2_ip}/${BGP_netmask}"
		type "clear"; press Enter
		type "ip r s"; press Enter

		wait "${router1_Lo_ip} via ${router2_BGP2_ip} dev ge-0-0 proto bird metric 200"
		wait "${LAN1_ip}/${default_netmask} via ${router2_BGP2_ip} dev ge-0-0 proto bird metric 200"
		wait "${BGP1_ip}/${BGP_netmask} via ${router2_BGP2_ip} dev ge-0-0 proto bird metric 200"

		type "clear"; press Enter
	}

	LAN4_ARM {
		exec bash "ping ${MS_ip} -c5"
		exec bash "ping ${router2_BGP1_ip} -c5"
		exec bash "ping ${router1_OSPF1_ip} -c5"
	}

	router2 {
		unplug link BGP1_side
		sleep 10s
	}

	UB1 {
		type "clear"; press Enter
		type "ip r s"; press Enter

		sleep 2s

		wait !"metric 200"

		type "clear"; press Enter
	}

	UB2 {
		type "ip r s"; press Enter
		wait !"${router1_Lo_ip} via ${router2_BGP2_ip} dev ge-0-0 proto bird metric 200"
		wait !"${LAN1_ip}/${default_netmask} via ${router2_BGP2_ip} dev ge-0-0 proto bird metric 200"

		type "clear"; press Enter
	}

	LAN4_ARM {
		exec bash "! (ping ${MS_ip} -c3)"
		exec bash "! (ping ${router1_OSPF1_ip} -c3)"
	}

	router2 {
		plug link BGP1_side
		sleep 1m
	}

	UB1 {
		type "ip r s"; press Enter

		wait "${router1_Lo_ip} via ${router1_OSPF1_ip} dev ge-0-0 proto bird metric 110"
		wait "${UB2_Lo0_ip} via ${router2_BGP1_ip} dev ge-2-0"
		wait "${UB2_Lo1_ip} via ${router2_BGP1_ip} dev ge-2-0 proto bird metric 200"

		type "clear"; press Enter
	}

	UB2 {
		type "ip r s"; press Enter
		wait "${router1_Lo_ip} via ${router2_BGP2_ip} dev ge-0-0 proto bird metric 200"
		wait "${LAN1_ip}/${default_netmask} via ${router2_BGP2_ip} dev ge-0-0 proto bird metric 200"

		type "clear"; press Enter
	}

	LAN4_ARM {
		exec bash "ping ${MS_ip} -c5"
		exec bash "ping ${router2_BGP1_ip} -c5"
		exec bash "ping ${router1_OSPF1_ip} -c5"
	}
}
