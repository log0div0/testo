
include "./installations.testo"

[no_snapshots]
test http_interception: configure_net
{
	url_proxy exec bash """
		iptables -t nat -A PREROUTING -p tcp --dport 80 -j REDIRECT --to-port 3128

		/usr/local/squid/sbin/squid

		for i in {1..10}; do command cat /usr/local/squid/var/logs/cache.log | fgrep \"Accepting NAT intercepted SSL bumped\" && break || sleep 10; done
		cat /usr/local/squid/var/logs/cache.log | fgrep \"Accepting NAT intercepted SSL bumped\"
	"""

	url_client exec bash """
		cd /tmp
		wget http://192.168.1.2/images/overlay.png
		(! wget http://192.168.1.2/images/pic02.jpg &> out)
		cat out
		cat out | fgrep Forbidden
	"""
}

macro copy_cert_to_flash(cert) {
	plug flash pubkey_flash;
	wait timeout 5s
	exec bash """
		mount /dev/sdb1 /media
		cp """ + $cert + """ /media
		umount /media
	"""
	unplug flash pubkey_flash
}

test https_interception: configure_net
{
	url_client, url_server, url_proxy exec bash "date --set=\"2018-09-30 10:30:00.000\""

	url_server {
		copy_cert_to_flash("/opt/rootCA.crt")
		copy_cert_to_flash("/opt/server.csr")
	}

	url_proxy {
		copy_cert_to_flash("/usr/local/squid/etc/squidCA.crt")
	}

	url_proxy, url_client {
		plug flash pubkey_flash;
		wait timeout 5s
		exec bash """
			mount /dev/sdb1 /media
			mkdir /usr/share/ca-certificates/extra
			cp /media/rootCA.crt /usr/local/share/ca-certificates/rootCA.crt
			cp /media/squidCA.crt /usr/local/share/ca-certificates/squidCA.crt
			chmod 644 /usr/local/share/ca-certificates/rootCA.crt
			chmod 644 /usr/local/share/ca-certificates/squidCA.crt
			umount /media
		"""
		unplug flash pubkey_flash
		exec bash """
			update-ca-certificates
		"""
	}

	url_proxy exec bash """
		iptables -t nat -A PREROUTING -p tcp --dport 443 -j REDIRECT --to-port 3129

		/usr/local/squid/sbin/squid

		for i in {1..10}; do command cat /usr/local/squid/var/logs/cache.log | fgrep \"Accepting NAT intercepted SSL bumped\" && break || sleep 10; done
		cat /usr/local/squid/var/logs/cache.log | fgrep \"Accepting NAT intercepted SSL bumped\"
	"""

	url_client exec bash """
		cd /tmp
		wget https://192.168.1.2
		(! wget https://192.168.1.2/images/pic02.jpg &> out)
		cat out
		cat out | fgrep Forbidden
	"""
}

test https_clamav: https_interception
{
	url_client, url_server, url_proxy exec bash "date --set=\"2018-09-30 10:30:00.000\""

	url_server {
		exec bash "mkdir /opt/static-website-example-master/files"
		copyto "./server/eicar.txt" "/opt/static-website-example-master/files/eicar.txt"
		exec bash "chown -R www-data:www-data /opt/static-website-example-master/files"
	}

	url_client exec bash """
		cd /tmp
		wget https://192.168.1.2
		(! wget https://192.168.1.2/files/eicar.txt &> out)
		cat out
		cat out | fgrep Forbidden
	"""
}

test https_proxy_cert_not_imported: configure_net
{
	url_client, url_server, url_proxy exec bash "date --set=\"2018-09-30 10:30:00.000\""

	url_server {
		copy_cert_to_flash("/opt/rootCA.crt")
		copy_cert_to_flash("/opt/server.csr")
	}

	url_proxy, url_client {
		plug flash pubkey_flash;
		wait timeout 5s
		exec bash """
			mount /dev/sdb1 /media
			mkdir /usr/share/ca-certificates/extra
			cp /media/rootCA.crt /usr/local/share/ca-certificates/rootCA.crt
			umount /media
		"""
		unplug flash pubkey_flash
		exec bash """
			update-ca-certificates
		"""
	}

	url_proxy exec bash """
		iptables -t nat -A PREROUTING -p tcp --dport 443 -j REDIRECT --to-port 3129

		/usr/local/squid/sbin/squid

		for i in {1..10}; do command cat /usr/local/squid/var/logs/cache.log | fgrep \"Accepting NAT intercepted SSL bumped\" && break || sleep 10; done
		cat /usr/local/squid/var/logs/cache.log | fgrep \"Accepting NAT intercepted SSL bumped\"
	"""

	url_client exec bash """
		cd /tmp
		wget https://192.168.1.2
		(! wget https://192.168.1.2/images/pic02.jpg &> out)
		cat out
		cat out | fgrep Forbidden
	"""
}

