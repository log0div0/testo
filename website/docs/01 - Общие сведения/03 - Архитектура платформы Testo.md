# Архитектура платформы Testo

## Основные составляющие

Платформа Testo построена на трёх основных компонентах

1. Специально разработанный язык тестовых сценариев Testo-lang и интерпретатор для этого языка
2. Интеграция с гипервизорами, через взаимодействие с которыми происходит имплементация тестовых сценариев
3. Распознавание состояния экрана виртуальных машин с помощью нейросетей

<br/><br/>

![Общая схема архитектуры фреймворка](/static/docs/general.png)

<br/><br/>
<center><em>Рис. 1. Архитектура платформы Testo</em></center>

### Язык Testo-lang

Для запуска тестовых сценариев в платформе Testo необходимо описать виртуальный стенд, котором будут прогоняться тесты, а также определить действия, которые будут применяться к этому виртуальному стенду. Язык Testo-lang позволяет в удобном виде объявлять виртуальные машины, флешки и сети, совокупность которых и будет определять тестовый стенд. Также с помощью языка Testo-lang можно интуитивно-понятным образом определять набор действий, которые будут применяться к виртуальному стенду. Эти действия могут как просто имитировать действия человека (набрать текст на клавиатуре, передвинуть мышку, вставить флешку, выключить питание), так и олицетворять более высокоуровневые команды, которые доступны при наличии гостевых дополнений на виртуальных машинах (выполнить bash-команду, скопировать файл с хостовой машины на виртуалку).

Такой подход позволяет платформе Testo разворачивать стенд "на лету", не требуя от пользователя вообще никаких подготовительных действий. Все, что требуется от пользователя - запустить тестовые сценарии, и вся виртуальная инфраструктура появится автоматически. Этот процесс можно сравнить в процессом компиляции - все, что требуется для компиляции - набор исходных кодов.

После описания тестовых сценариев и инфрастуктуры в работу вступает интерпретатор `testo`, который через взаимодействие с гипервизором начинает имплементировать тестовый сценарий.

### Интеграция с гипервизорами

Для прогона тестов платформа Testo преобразует сценарии в файлах `.testo` в набор команд для гипервизора, который выполняет управление виртуальной инфраструктурой. Несмотря на то, что архитектура платформы Testo подразумевает независимость тестовых сценариев от вида используемого гипервизора, на текущий момент полноценно реализована только работа с гипервизором [QEMU](https://www.qemu.org/). В будущем планируется добавить поддержку гипервизора HyperV копании Microsoft.

### Нейросети

В качестве основного "тестирующего" действия в платформе Testo является команда `wait`, которая позволяет понять, наступило ли какое-либо событие на экране монитора, или нет. В качестве такого события может выступать появление определенной надписи или картинки на экране. Если в течение заданного периода времени такого события не наступило - это будет приводить к "падению" теста. Например, запустив процесс инициализации, пользователь ожидает увидеть надпись "Успешно" в течение максимум 10 минут. Если в течение 10 минут такой надписи так и не появилось - то пользователь может быть уверен, что что-то пошло не так и тест нужно завершить с ошибкой.

Для определения событий на экране платформа Testo использует нейросети. В течение заданного промежутка времени команды `wait` у виртуальной машины будут сниматься скриншоты, который затем попадают на анализ в движок поиска определенного текста на экране. Если необходимый текст был найден, то команда `wait` завершается успешно и выполнение теста продолжается. Если же текст так и не найден, то тест завершается с ошибкой.

Т.к. поиск происходит исключительно с помощью нейросетей, платформа Testo не требует наличия специальных агентов внутри гостевой виртуальной машины и может с равным успехом обрабатывать вывод на экран как консольной версии FreeBSD, так и графической оболочки Windows 10 ровно в том виде, в котором их видит конечный пользователь.


## Гостевые дополнения

По умолчанию платформа Testo позволяет применять к виртуальным машинам действия, имитирующие действия человека (набор текста на клавиатуре, ожидания события на экране, включение/отключения питания и пр.). Такой подход позволяет платформе Testo сохранять принцип "Черного ящика" для тестируемой системы, вдеь для выполнения таких дейсвтвий не требуется наличие никаких дополнительных агентов внутри тестируемой системы, которые могли бы повлиять на ход выполнения тестов.

<br/><br/>

![Общая схема архитектуры фреймворка с использованием гостевых
дополнений](/static/docs/general-negotiator.png)

<br/><br/>
<center><em>Рис. 2. Архитектура платформы Testo при использовании гостевых дополнений</em></center>
<br/><br/>

Впрочем, иногда соблюдать принцип черного ящика вовсе необязательно. Такое может быть, например, если происходит управление не основной тестируемой системой, а вспомогательной. В этом случае в платформе Testo существует возможность упростить взаимодействие с виртуальной машиной. Для этого необходимо установить внутрь гостевой системы агент `testo-guest-additions`, который поставляется вместе с Testo. После установки этого агента пользователю становятся доступны новые команды, такие как `exec bash`(выполнение баш-скриптов), `copyto`(копирование файлов внутрь виртуалки) и др.

Агент `testo-guest-additions` представляет собой специальный системный сервис, который запускается с правами администратора. При выполнении высокоуровневых команд платформа Testo обращается напрямую к этому сервису.

Применение гостевых дополнений может сильно упростить написание тестовых сценариев там, где это возможно.