---
id: machine
title: Oбъявление виртуальной машины
---

Для объявления виртуальных машин используется директива `machine`.
Формат директивы выглядит следующим образом:

    machine <name> {
        <attr1 [name]: <value1>
        <attr2 [name]: <value1>
        <attr3 [name]: <value1>
        ...
    }

> Объявление виртуальной машины само по себе не ведет к ее созданию в
> гипервизоре. Реальное создание виртуальной машины произойдет при запуске
> теста, в котором участвует эта машина.

В сущности, объявление виртуальной машины состоит из перечисления
атрибутов, часть из которых является обязательными. Атрибуты должны быть
отделены друг от друга переносом строки. После объявления машины также
должен следовать символ переноса строки.

Для виртуальной машины необходимо указать ее имя `<name>` в формате
[идентификатора](lexems#идентификаторы). Имя виртуальной
машины должно быть уникальным среди других виртуальных машин.

Атрибут состоит из названия, необязательного имени и обязательного
значения. В качестве имени используется идентификатор, а в качестве
значения могут выступать:

- числовая константа
- спецификатор количества памяти
- строка
- логическая константа
- группа вложенных атрибутов

Некоторые атрибуты также могут иметь имя. В настоящее время единственный
атрибут, который обязан иметь имя - это атрибут `nic`.

Для виртуальной машины существует набор обязательных атрибутов, которые
необходимо указать:

- `cpus` - количество ядер процессора. Значение атрибута должно быть
  **числом**.
- `ram` - количество оперативной памяти. Значение атрибута должно
  быть **спецификатором количества памяти**.
- `iso` - путь к файлу с iso-образом, который можно использовать для
  установки ОС. Значение атрибута должно быть **строкой**.
- `disk_size` - размер основного жесткого диска. Значение атрибута
  должно быть **спецификатором количества памяти**.

Для указания сетевых адаптеров можно использовать атрибут `nic`. Атрибут
`nic` должен иметь имя (чтобы различать адаптеры между собой), и в
качестве значения должна выступать группа вложенных атрибутов:

- `attached_to` - имя сети, к которой подключается адаптер. Сеть
  должна быть предвариетльно объявлена с помощью директивы `network`
- `adapter_type` - модель адаптера. Необязательный атрибут. Значение
  атрибута может принимать одно из следующих значений: `ne2k_pci`,
  `i82551`, `i82557b`, `i82559er`, `rtl8139`, `e1000`, `pcnet`,
  `virtio`, `sungem`. Если не указать этот атрибут, то адаптер будет
  создан с моделью по-умолчанию, которая для гипервизора QEMU
  принимает значение `rtl8139`
- `mac` - MAC-адрес адаптера. Необязательный атрибут. Значение
  атрибута должно быть строкой в формате `00:11:22:33:44:55`. Если
  не указать этот атрибут, то МАС-адрес будет сгенерирован
  гипервизором случайным образом.

Ниже представлен итоговый пример конфигурации виртуальной машины. Нужно
отметить, что значение `$ISO_DIR` будет вычислено, исходя из значения
параметра `ISO_DIR`. Если такой параметр не задан, то итоговая строка
примет значение `/ubuntu-16.04.6-server-amd64.iso"`

```
machine example_machine {
    cpus: 1
    ram: 1024Mb
    iso: "${ISO_DIR}/ubuntu-16.04.6-server-amd64.iso"
    disk_size: 4Gb
    nic nat: {
        attached_to: "nat"
        adapter_type: "e1000"
    }

    nic WAN: {
        attached_to: "internal"
        network: "net2"
        mac: "52:54:00:00:00:00"
        adapter_type: "e1000"
    }

    nic LAN: {
        attached_to: "internal"
        network: "net1"
        mac: "52:54:00:00:00:11"
        adapter_type: "e1000"
    }
}
```

## Кешируемость виртуальных машин

В платформе Testo предусмотрен механизм определения актуальности
конфигурации виртуальных машин. Если с момента последнего запуска
конфигурация виртуальной машины существенно изменилась, то саму
виртуальную машину необходимо пересоздать, а все тесты, в которых она
учавствует - прогнать заново. Это одна из проверок, которая определяет
[актуальность кеша теста](test#проверка-кеша).

Ниже приведен список вопросов, которые платформа Testo считает
существенными при определении закешированности конфигурации виртуальной
машины:

- Изменилось ли значение атрибутов `cpu`, `ram`, `disk_size`?
- Изменились ли настройки или названия сетевых адаптеров? (Если
  поменялся порядок следования сетевых адаптеров, кеш считается
  актуальным)
- Изменился ли файл, указанный в атрибуте `iso`?

Если ответ хотя бы на один из этих вопросов - положительный, то кеш
считается неактуальным и виртуальную машину необходимо создать заново.
