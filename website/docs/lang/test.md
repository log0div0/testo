# Объявление тестов

Для объявления тестов используется директива
`test`. Формат теста выглядит следующим образом:

```text
[[
	<attr1>: <value1>
	<attr2>: <value1>
	<attr3>: <value1>
]]
test <test_name>[: test_parent1, test_parent2, ...]
{
	command1
	command2
	...
}
```

Заголовок теста состоит из необязательного набора атрибутов, заключенных
в квадратные скобки, после которого должен быть обязательный перенос
строки, ключевого слова `test`, названия теста (название теста должно
быть уникальным среди тестов), а также перечисления родительских тестов
(если таковые имеются). Тело теста состоит из набора команд.

Атрибут состоит из названия и значения. В качестве имени используется
идентификатор, а в качестве значения могут выступать:

- числовая константа
- спецификатор количества памяти
- строка
- логическая константа
- группа вложенных атрибутов

Для тестов могут быть указаны следующие атрибуты:

- `no_snapshots` - Значение атрибута должно быть **логической
  константой**. В случае значения `true`, для участвующих
  виртуальных машин не будут создаваться снепшоты гипервизора. Это
  может пригодиться для экономии места на диске. Значение
  по-умолчанию - `false`;
- `description` - Значение атрибута должно быть **строкой**.
  Произвольное описание теста, которое затем будет сохранено в
  отчете о проведенных тестах в json-формате при указании аргумента
  командной строки `json_report`.

Указание родительских тестов необходимо в том случае, если выполнение
теста зависит от успешного выполнения более базовых тестов. Например,
тест с настройкой сети должен полагаться на тест с установкой
операционной системы.

## Формат команд

Логической единицей теста является **команда**. Формат команды выглядит
следующим образом:

```text
<vm_name1>[, vm_name2, vm_name3, ...] <action>
```

Команда состоит из двух частей: перечисления виртуальных машин
(минимально должна быть указана хотя бы одна виртуальная машина), а
также [действия](actions), которое можно
применить к это й машине. В качестве действия может выступать **блок
действий**, в этом случае команда принимает вид:

```text
<vm_name1>[, vm_name2, vm_name3, ...] {
	action1
	action2
	action3; action4; action5
	action6;
	{
		action7; action8
	}
}
```

Также вместо действий в команде можно использовать
[циклы](for) и [условия](if).

Внутри блока действия необходимо разделять либо символом переноса
строки, либо точкой с запятой.

## Порядок работы тестов

Выполнение теста можно разделить на четыре этапа:

- Проверка кеша
- Подготовка среды выполнения
- Выполнение команд
- Фиксация среды выполнения

### Проверка кеша

Для экономии времени в платформе Testo предусмотрен механизм кеширования
тестов. Если с момента последнего запуска в тесте не изменились
существенные детали, то тест считается закешированным и его фактического
выполнения не происходит. Если же кеш считается недействительным, то сам
тест **и все его потомки** помечаются флагом "необходимо выполнить".
Ниже приведен список вопросов, которые платформа Testo считает
существенными при определении закешированности теста:

- Есть ли недействительный кеш хотя бы у одного предка теста?
- Изменился ли заголовок теста?
- Изменились ли команды в теле теста?
- Изменилось ли значение параметров, участвующих в тесте?
- Изменилась ли существенно конфигурация виртуальных машин,
  участвующих в тесте?
- Изменилась ли существенно конфигурация флеш-накопителей,
  участвующих в тесте?
- Изменилась ли существенно конфигурация виртуальных сетей,
  учавствующих в тесте?
- Изменились ли контрольные суммы файлов, участвующих в действии
  `copyto`?
- Изменились ли контрольные суммы файлов в папках флеш-накопителей
  (атрибут `folder`)?
- Изменились ли контрольные суммы iso-образов, участвующих в действии `plug dvd`?

При положительном ответе хотя бы на один из перечисленных вопросов кеш
теста считается недействительным и он помечается флагом "необходимо
выполнить". Вместе с ним будут запланированы к выполнению все потомки
этого теста.

> Помимо встроенных в Testo механизмов определения закешированности
> тестов, пользователь может вручную сбросить кеш у определенных тестов,
> используя аргумент командной строки `invalidate <wildcard match>`. При
> этом сбрасывая кэш теста, пользователь автоматически сбрасывает кеш всех
> его потомков

> Существует два режима подсчета целостности файлов, участвующих в `copyto`, `folder` и `plug_dvd`.
> Если размер файла меньше или равен 1 МБ, то подсчёт контроль целостности выполняется на основе
> содержимого файла. Иначе в расчёт берется только временная метка с датой последнего изменения файла.
> При необходимости порог смены режимов подсчёта можно менять с помощью аргумента командной строки `content_cksum_maxsize`.

Если же кеш теста оказывается действительным, то его выполнение
пропускается и проверка переходит к следующему тесту.

### Подготовка среды выполнения

Если тест был помечен флагом "необходимо выполнить", то все
виртуальные машины будут приведены в состояние, необходимое для
проведения теста:

- Будут созданы новые виртуальные машины, которые не использовались
  ранее в родительских тестах. При этом они останутся в выключенном
  состоянии, для их запуска необходимо указать действие `start`.
- Если родительские тесты не были помечены атрибутом
  `[no_snapshots]`, то Testo сможет восстановить снепшоты
  виртуальных машин и флеш-носителей и вернуть их в то состояние, в
  котором они находились на момент окончания родительских тестов.
- Если родительские тесты имеют атрибут `[no_snapshots]`, то у них
  отсутствуют снепшоты, которые можно было бы восстановить. В этом
  случае Testo проведет поиск "опорного теста", который не помечен
  как `[no_snapshots]`, и восстановит состояние виртуальных машин и
  флеш-носителей в то состояние, в котором они были на момент
  окончания опорного теста. Затем последовательно будут выполнены
  все промежуточные родительские тесты, что вернет виртуальную
  машину в нужное состояние.

### Выполнение команд

Выполнение команд заключается в последовательном применении действий к
виртуальным машинам, указанным в начале команды. Если в качестве
действия указан блок действий, то сначала все действия будут применены к
первой виртуальной машине, затем к следующей и т.д.

Если хотя бы одно действие завершается с ошибкой, то тест считается
провалившимся, и управление переходит к следующему тесту. Если у
проваленного теста были потомки, то они также будут считаться
проваленными по-умолчанию.

### Фиксация среды выполнения

После успешного выполнения теста платформа Testo зафиксирует состояния
виртуальных машин на момент окончания тестов. Если тест не был помечен
атрибутом `[no_snapshots: true]`, то будут созданы снепшоты всех
виртуальных машин и флеш-носителей. Помимо этого, будет обновлен кеш
теста.
