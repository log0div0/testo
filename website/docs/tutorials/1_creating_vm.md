---
id: 1_creating_vm
title: Часть 1. Самый первый тест
---

## С чем Вы познакомитесь

В этом первом уроке вы познакомитесь:
1. С основами объявления и создания виртуальных машин в тестовых сценариях
2. С атрибутом командной строки `stop_on_fail`
3. С режимом очистки созданных сущностей (`testo clean`)

## Начальные условия

1. Платформа `testo` установлена.
2. Установлен менеджер виртуальных машин `virt-manager`.
3. Имеется установочный образ [Ubuntu server 16.04](http://releases.ubuntu.com/16.04/ubuntu-16.04.6-server-amd64.iso) с расположением `/opt/ubuntu_server.iso`. Местоположение и название установочного файла может быть другим, в этом случае нужно будет соответствуующим образом поправить тестовый скрипт.
4. (Рекомендовано) Настроена [подсветка синтаксиса](/docs/getting_started/getting_started#настройка-подсветки-языка-testo-lang) `testo-lang` в Sublime Text 3.

## Вступление

Платформа Testo направлена на автоматизацию системных тестов. Системные тесты отличаются от других видов тестов тем, что в них происходит тестирование не только определенной программы, но целой системы в целом, в которой программа может выступать лишь одним из кирпичиков. Системное тестирование позволяет проверить насколько хорошо программа работает с учётом окружения, в котором ей приходится работать. В качестве окружения может выступать операционная система, сеть (в том числе Интернет), наличие определенных устройств и так далее. Отличный пример системных тестов - это проверка корректности работы инсталлятора программы в различных версиях ОС.

Следуя этой идеологии, в платформе Testo в качестве Тестируемой Системы (System Under Test - SUT) используется не сама программа, а целый **виртуальный стенд**, который может включать в себя виртуальные машины, виртуальные флешки и виртуальные сети.

В простейшем случае в качестве виртуального стенда может выступать одна **виртуальная машина**. Это минимальная виртуальная инфраструктура, с которой может работать платформа Testo.

Тесты предполагают не только наличие SUT, но также и действий, которые необходимо выполнить над Тестируемой Системой. Собственно, сам процесс тестирования можно представить как применение воздействий на SUT и сравнение наблюдаемого результата с ожидаемым.

Когда речь заходит о системных (то есть комплексных) тестах, то чаще всего предполагается, что такие тесты должен выполнять человек. Именно человек в состоянии выполнить все необходимые для системных тестов действия (а это не только ввод данных с клавиатуры и с мыши, но и более специфичные и сложные действия: вставка флешки, выдергивание сетевого кабеля, подача питания на машину). И именно человек чаще всего способен принять решение, насколько правильно наблюдаемое поведение системы.

Поэтому платформа Testo позволяет выстраивать тестовые сценарии буквально повторяя действия человека при тестировании SUT. Причём тестовые сценарии начинаются с настройки стенда для тестирования, ведь тестировщик начинает выполнение тестов с подготовки подходящей виртуальной среды. И лишь создав и настроив все виртуальные машины, тестировщик может переходить непосредственно к проведению сложных Тест-кейсов. Впрочем, иногда даже установку ОС можно рассматривать как полноценный Тест-кейс, если речь идёт о разработке собственной ОС.

Давайте рассмотрим все эти принципы на примере.

## С чего начать?

С чего необходимо начинать разработку тестовых сценарирев в платформе Testo?

Все тестовые сценарии хранятся в обычных текстовых файликах с расширением `.testo`. Тестовые сценарии разделяются на две больших составляющие:
1. Объявление виртуальной инфраструктуры.
2. Описание действий, которые необходимо применить к этой виртуальной инфраструктуре.

Итак, начинать разработку тестовых сценариев необходимо с объявления виртулальной инфраструктуры. Для этого используются специальные директивы: `machine` (виртуальная машина), `flash` (виртуальная флешка) и `network` - виртуальная сеть. В этой части мы рассмотрим только объявление виртуальной машины.

Давайте создадим пустой файлик `~/testo/hello_world.testo` и объявим в этом файлике первую собственную [виртуальную машину](/docs/lang/machine):

	machine my_ubuntu {
		cpus: 1
		ram: 512Mb
		disk_size: 5Gb
		iso: "/opt/ubuntu_server.iso"
	}

Объявление виртуальной машины заключается в использовании директивы `machine` после которого должно идти имя машины. Имя должно быть уникальным в пределах тестового проекта.

У виртуальной машины есть ряд атрибутов. Некоторые атрибуты являются обязательными, другие - опциональными. Обязательных атрибутов всего 4: `cpus`, `ram`, `disk_size` и `iso`. Рассмотрим их подробнее.

-   `cpus`: количество ядер в процессоре виртуальной машины
-   `ram`: количество оперативной памяти виртуальной машины
-   `disk_size`: размер жёсткого диска виртуальной машины
-   `iso`: путь к установочному образу ОС виртуальной машины

В качестве первой виртуальной машины мы будем использовать Ubuntu Server 16.04 с одним ядром, 512 Мегабайтами RAM и диском размером 5 Гигабайт. В качестве атрибута `iso` мы указываем путь к установочному iso-образу Ubuntu Server, который необходимо было скачать ранее.

Обратите внимание, что для задания количества памяти используются [специальные литералы](/docs/lang/lexems#спецификатор-количества-памяти), упрощающие указание оперативной памяти.

С другими (необязательными) атрибутами виртуальной машины мы познакомимся в дальнейших уроках.

## Попробуем запустить

Итак, мы закончили объявление виртуальной инфраструктуры нашего первого тестового проекта. Давайте попробуем запустить такой тестовый сценарий:

```sh
# sudo testo run ~/testo/hello_world.testo
```
Если всё было сделано правильно, то вы должны увидеть примерно следующий вывод интерпретатора:

	PROCESSED TOTAL 0 TESTS IN 0h:0m:0s
	UP-TO-DATE: 0
	RUN SUCCESSFULLY: 0
	FAILED: 0

Мы видим, что несмотря на то, что мы не написали ни одного теста, такой файл все равно можно интерпретировать. При этом, очевидно, никаких тестов не запускается.

Если открыть virtual manager и посмотреть на список существующих виртуальных машин, то мы не увидим в этом списке объявленную `ubuntu_server`. Так происходит, потому что **объявление виртуальной машины не означает её создания**. Объявление виртуальной машины лишь сообщает платформе Testo, что вы хотите использовать такую-то машину с таким-то атрибутами в своих тестах, и что называться в тестах она будет таким-то образом.

## Пишем первый тест

Непосредственное создание виртуальных машин происходит в **тестах**. Тесты в платформе Testo олицетворяют собой не только проведение тестовых (проверочных) действий с виртуальными машинами, но и вообще любые действия с виртуальными машинами, даже если эти действия совершенно точно не могут сломаться или не выполниться. Инами словами, **если вам нужно сделать что-то с виртуальной машиной, вы должны делать это внутри тестов**.

Для объявления [теста](/docs/lang/test) используется директива `test`. Каждый тест обязательно должен иметь уникальное имя. Давайте допишем в файл `~/testo/hello_world.testo` объявление нашего первого теста

	machine my_ubuntu {
		cpus: 1
		ram: 512Mb
		disk_size: 5Gb
		iso: "/opt/ubuntu_server.iso"
	}

	test my_first_test {
		my_ubuntu start
	}

Сам тест состоит из набора **команд**. Команда состоит из двух частей:

1. Перечисление виртуальных машин, к которым нужно применить определенное действие
2. Действие (или группа действий), которое нужно применить.

В нашем примере в тесте `my_first_test` фигурирует всего одна команда. В этой команде к виртуальной машине `my_ubuntu` применяется действие [`start`](/docs/lang/actions#start), которое включает виртуальную машину. Давайте запустим этот тест и посмотрим, что у нас получилось.

	TESTS TO RUN:
	my_first_test
	[  0%] Preparing the environment for test my_first_test
	[  0%] Creating virtual machine my_ubuntu
	[  0%] Taking snapshot initial for virtual machine my_ubuntu
	[  0%] Running test my_first_test
	[  0%] Starting virtual machine my_ubuntu
	[  0%] Taking snapshot my_first_test for virtual machine my_ubuntu
	[100%] Test my_first_test PASSED in 0h:0m:1s
	PROCESSED TOTAL 1 TESTS IN 0h:0m:1s
	UP-TO-DATE: 0
	RUN SUCCESSFULLY: 1
	FAILED: 0

Мы видим, что тест `my_first_test` попал в очередь `TESTS TO RUN`, а значит платформа Testo готова этот тест выполнить. Затем начинается непосредственное выполнение теста.

Выполнение тестов разбивается на три этапа:
1. Подготовка среды выполнения
2. Выполнение команд
3. Фиксация среды выполнения

На этапе подготовки среды выполнения платформа Testo должна убедиться, что вся задействованная в тесте инфраструктутра создана и находится в надлежащем состоянии.

В нашем случае, Testo видит, что в тесте происходит обращение к виртуальной машине `my_ubuntu`. Т.к. этой виртуальной машины пока не существует, платформа Testo создает её, используя тот список атрибутов, который мы указали в объявлении. Сразу после создания виртуальной машины Testo запоминает состояние этой машины, делая изначальный снепшот `initial`. После этого среда для выполнения теста подготовлена и можно приступать к самим командам.

В платформе Testo машины создаются в выключенном состоянии и для того, чтобы с ними можно было что-то делать, чаще всего их нужно включить. Как раз это и происходит в команде `my_ubuntu start`.

На этом список команд завершается и начинается этап фиксации среды выполения. При успешном окончании теста для виртуальных машин, участвовавших в тесте, создаётся снепшот с именем выполненного теста, что мы и видим в выводе интерпретатора. После этого тест считается завершенным. Т.к. больше тестов у нас не предусмотрено, интерпретатор `testo` завершает свою работу.

Если зайти в список виртуальных машин в `virtual manager`, то можно убедиться, что там появилась новая машина `ubuntu_server`. Однако, эта машина находится в выключенном состоянии. Почему так происходит, ведь мы в тесте явно указали. что хотим включить машину `ubuntu_server`?

На самом деле витрульная машина действительно была включена во время выполнения теста, и была зафиксирована в этом состоянии с помощью снепшота `my_first_test` (в этом можно убедиться, открыв меню снепшотов виртуальной машины)

<br/><br/>
![Список снепшотов my_ubuntu](assets/tutorials/1_creating_vm/snapshots.png)
<br/><br/>

Но по окончанию теста `my_first_test` платформа Testo определила, что виртуальная машина `my_ubuntu` дальше использоваться не будет, и выключила её для экономии ресурсов. Поэтому мы наблюдаем виртуальную машину в выключенном состоянии.

## Stop_on_fail

Но что, если мы хотим увидеть свою виртуальную машину в том состоянии, в котором она была на момент окончания теста? Что, если мы бы хотели увидеть виртуальную машину во включенном состоянии?

Для этого нужно будет сделать два шага.

Во-первых, давайте добавим в тест новое действие [`abort`](/docs/lang/actions#abort)
	
	test my_first_test {
		my_ubuntu {
			start
			abort "Stop here"
		}
	}

В нашем тесте всё ещё фигурирует одна команда, однако в качестве действия теперь указана целая группа действий, заключенная в фигурные скобочки. Добавилось действие `abort`, которое прерывает выполнение теста и выдает соответствующее сообщение об ошибке. Если запустить тест, мы увидим следующий вывод

	Some tests have lost their cache:
		- my_first_test
	Do you confirm running them and all their children? [y/N]: y
	TESTS TO RUN:
	my_first_test
	[  0%] Preparing the environment for test my_first_test
	[  0%] Restoring snapshot initial for virtual machine my_ubuntu
	[  0%] Running test my_first_test
	[  0%] Starting virtual machine my_ubuntu
	/home/alex/testo/hello_world.testo:12:3: Caught abort action on virtual machine my_ubuntu with message: Stop here
	[100%] Test my_first_test FAILED in 0h:0m:1s
	PROCESSED TOTAL 1 TESTS IN 0h:0m:1s
	UP-TO-DATE: 0
	RUN SUCCESSFULLY: 0
	FAILED: 1
		 -my_first_test
	At least one of the tests failed

В начале выполнения высвечивается предупреждение о потере кеша в тесте `my_first_test`. Кеширование мы рассмотрим в следующих уроках, поэтому сейчас просто молча соглашаемся в этим.

Мы видим, что тест теперь считается `FAILED`, причем мы видим конкретное место в тестовом сценарии, которое привело к ошибке. Сейчас это ожидаемая ошибка, т.к. мы сами указали, что она должна была случиться.

Однако если мы откроем `virtual manager` и посмотрим на виртуальную машину `my_ubuntu`, то снова обнаружим ее в выключенном состоянии, хотя в этот раз тест не был успешно выполнен (в меню снепшотов теперь нет снепшота `my_first_test`). И снова, причина кроется в том, что платформа Testo выключает виртуальные машины сразу после того, как они становятся ненужными в процессе выполнения тестов. Даже если виртуальная машина становится ненужной из-за ошибки.

Однако, существует способ остановить выполнение тестовых сценариев при возникновении любой ошибки. Для этого при запуске интерпретатора необходимо передать параметр командной строки `--stop_on_fail`


```sh
# sudo testo run ~/testo/hello_world.testo --stop_on_fail
```
Мы увидим следующую картину

	TESTS TO RUN:
	my_first_test
	[  0%] Preparing the environment for test my_first_test
	[  0%] Restoring snapshot initial for virtual machine my_ubuntu
	[  0%] Running test my_first_test
	[  0%] Starting virtual machine my_ubuntu
	/home/alex/testo/hello_world.testo:12:3: Caught abort action on virtual machine my_ubuntu with message: Stop here
	[100%] Test my_first_test FAILED in 0h:0m:1s

Теперь если зайти в `virtual manager` мы увидим машину `my_server` в таком состоянии

<br/><br/>
![Убунту запущена](assets/tutorials/1_creating_vm/ubuntu_started.png)
<br/><br/>

Именно таким способом (`abort` + `stop_on_fail`) в платформе Testo реализована система "точек останова", которые позволяют вам остановить выполение текстов и посмотреть на свои виртуалки ровно в тот момент, когда вы этого захотите.

## testo clean

В процессе выполнения тестов мы увидели, что была создана виртуальная машина `my_ubuntu`, которая теперь будет существовать у нас на компьютере неопределенно долго. Если же мы хотим освободить место на жёстком диске и избавиться от созданной машины `my_ubuntu`, можно использовать режим очистки сущностей платформы Testo. Для этого достаточно написать команду 

```sh
# sudo testo clean
```

Мы увидим следующий вывод

	Deleted virtual machine my_ubuntu

Что будет означать, что наша машина `my_ubuntu` успешно удалена.

> Команда `testo clean` не удаляет сущности, вручную созданные пользователем. Очищается только автоматически созданная инфраструктура

## Готовый тестовый скрипт

Итоговый тестовый скрипт можно скачать [здесь](/docs/assets/tutorials/1_creating_vm/creating_vm.testo)
