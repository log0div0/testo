# Часть 10. Конструкция if

## С чем Вы познакомитесь

В этой части вы познакомитесь с механизмом условий в платформе Testo, а также увидите пример использования поисковых выражений в действии `wait`.

## Начальные условия

1. Платформа `testo` установлена.
2. Установлен менеджер виртуальных машин `virt-manager`.
3. На хостовой машине имеется прямой (без прокси) доступ в Интернет
4. Имеется установочный образ [Ubuntu server 16.04](http://releases.ubuntu.com/16.04/ubuntu-16.04.6-server-amd64.iso) с расположением `/opt/iso/ubuntu_server.iso`. Местоположение и название установочного файла может быть другим, в этом случае нужно будет соответствующим образом поправить тестовый скрипт.
5. Имеется образ с гостевыми дополнениями Testo в одной папке с установочным образом Ubuntu.
6. (Рекомендовано) Настроена [подсветка синтаксиса](/docs/getting_started/getting_started#настройка-подсветки-языка-testo-lang) `testo-lang` в Sublime Text 3.
7. (Рекомендовано) Проделаны шаги из [девятой части](9_macros).

## Вступление

В ходе предыдущей части мы смогли добиться того, чтобы наш код стал более структурированным и компактным. Тем не менее, в нём есть еще как минимум один момент, который бы хотелось улучшить.

В прошлом мы неоднократно сталкивались с необходимостью немного корректировать тест с установкой Ubuntu Server. Это было связано с тем, что процесс установки Ubuntu Server все-время немного менялся в зависимости от параметров наших виртуальных машин: есть ли у неё сетевые адаптеры или доступ в Интернет и так далее. Сейчас наш макрос `install_ubuntu` неплохо справляется только если выполнены следующие условия:

1. У виртуальной машины есть два или более адаптера;
2. У виртуальной машины есть доступ в Интернет;
3. Пароль администратора достаточно слабый, чтобы вызвать соответствующее предупреждение.

Но что, если мы захотим, чтобы наш макрос работал в любых условиях? Чтобы при любых конфигурациях виртуальных машин макрос `install_ubuntu` корректно отрабатывал?

Очевидно, что для этого в макрос необходимо заложить возможность "вести себя" немного по-разному в зависимости от различных условий. Именно для этого в языке `testo-lang` предусмотрены [условные конструкции](/docs/lang/if) `if-else`. Условия могут базироваться на обычных сравнениях строковых констант и параметров, так и на текущем содержимом экрана. В этой части обучения мы опробуем оба вида ветвлений, начиная с более базовых сравенний строк и заканчивания проверкой содержимого экрана.

## С чего начать?

Для начала попробуем доработать свой макрос `install_ubuntu` так, чтобы он мог успешно отрабатывать в условиях ввода как нормального пароля администратора, так и слишком простого. Для начала необходимо понять, в чём разница с точки зрения набора действий в обоих случаях.

Сейчас, когда при установке используется слабый пароль, макрос выглядит так:

```testo
macro install_ubuntu(hostname, login, password = "${default_password}") {
	start
	...
	wait "Choose a password for the new user"; type "${password}"; press Enter
	wait "Re-enter password to verify"; type "${password}"; press Enter
	wait "Use weak password?"; press Left, Enter
	wait "Encrypt your home directory?"; press Enter
	...
}
```

То есть мы ожидаем, что после ввода пароля появится экран с предупреждением `"Use weak password?"`, в котором мы должны нажать клавиши Left и Enter.

Очевидно, что в случае использовании нормального пароля такой экран не появится и макрос будет выглядеть так:

```testo
macro install_ubuntu(hostname, login, password = "${default_password}") {
	start
	...
	wait "Choose a password for the new user"; type "${password}"; press Enter
	wait "Re-enter password to verify"; type "${password}"; press Enter
	wait "Encrypt your home directory?"; press Enter
	...
}
```

Давайте попробуем объединить оба случая с помощью условия `if`.

> Обратите внимание, что в данный момент мы пробуем не самое оптимальное решение проблемы. Более оптимальное решение (распознавание содержимого экрана) будет рассмотрено позже в этом уроке. Текущее решение играет больше ознакомительную роль

```testo
macro install_ubuntu(hostname, login, password="${default_password}", is_weak_password="") {
	start
	...
	wait "Choose a password for the new user"; type "${password}"; press Enter
	wait "Re-enter password to verify"; type "${password}"; press Enter
	if ("${is_weak_password}") {
		wait "Use weak password?"; press Left, Enter
	}
	wait "Encrypt your home directory?"; press Enter
	...
}
```
В данном случае для управления процессом установки ОС мы использовали дополнительный аргумент макроса - `is_weak_password`. В случае, если значение этого аргумента **имеет ненулевую длину**, то выражение внутри `if` будет равно `TRUE`, и выполнится соответствующая ветка действий. Если же длина значения аргумента нулевая, то выражение будет равно `FALSE` и действия не будут выполнены.

Мы спроектировали макрос так, чтобы по умолчанию пароль `${default_password}` считался достаточно сложным, чтобы дополнительный экран с предупреждением не появлялся. Т.к. текущий наш пароль по умолчанию - это `1111`, то такой макрос не будет работать в случае использования значений по умолчанию. Давайте в этом убедимся.


<Terminal height="600px">
	<span className="">user$ sudo testo run ./ --stop_on_fail --param ISO_DIR /opt/iso --test_spec server_install_ubuntu --assume_yes<br/></span>
	<span className="blue bold">TESTS TO RUN:<br/></span>
	<span className="magenta ">server_install_ubuntu<br/></span>
	<span className="blue ">[  0%] Preparing the environment for test </span>
	<span className="yellow ">server_install_ubuntu<br/></span>
	<span className="blue ">[  0%] Restoring snapshot </span>
	<span className="yellow ">initial</span>
	<span className="blue "> for virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Running test </span>
	<span className="yellow ">server_install_ubuntu<br/></span>
	<span className="blue ">[  0%] Calling macro </span>
	<span className="yellow ">install_ubuntu(</span>
	<span className="yellow ">hostname="server"</span>
	<span className="yellow ">, </span>
	<span className="yellow ">login="server-login"</span>
	<span className="yellow ">, </span>
	<span className="yellow ">password="1111"</span>
	<span className="yellow ">, </span>
	<span className="yellow ">is_weak_password=""</span>
	<span className="yellow ">)</span>
	<span className="blue "> in virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Starting virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Waiting </span>
	<span className="yellow ">English </span>
	<span className="blue ">for 1m with interval 1s in virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Pressing key </span>
	<span className="yellow ">ENTER </span>
	<span className="blue ">on virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Waiting </span>
	<span className="yellow ">Install Ubuntu Server </span>
	<span className="blue ">for 1m with interval 1s in virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Pressing key </span>
	<span className="yellow ">ENTER </span>
	<span className="blue ">on virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Waiting </span>
	<span className="yellow ">Choose the language </span>
	<span className="blue ">for 1m with interval 1s in virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Pressing key </span>
	<span className="yellow ">ENTER </span>
	<span className="blue ">on virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Waiting </span>
	<span className="yellow ">Select your location </span>
	<span className="blue ">for 1m with interval 1s in virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Pressing key </span>
	<span className="yellow ">ENTER </span>
	<span className="blue ">on virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Waiting </span>
	<span className="yellow ">Detect keyboard layout? </span>
	<span className="blue ">for 1m with interval 1s in virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Pressing key </span>
	<span className="yellow ">ENTER </span>
	<span className="blue ">on virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Waiting </span>
	<span className="yellow ">Country of origin for the keyboard </span>
	<span className="blue ">for 1m with interval 1s in virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Pressing key </span>
	<span className="yellow ">ENTER </span>
	<span className="blue ">on virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Waiting </span>
	<span className="yellow ">Keyboard layout </span>
	<span className="blue ">for 1m with interval 1s in virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Pressing key </span>
	<span className="yellow ">ENTER </span>
	<span className="blue ">on virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Waiting </span>
	<span className="yellow ">Primary network interface </span>
	<span className="blue ">for 1m with interval 1s in virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Pressing key </span>
	<span className="yellow ">ENTER </span>
	<span className="blue ">on virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Waiting </span>
	<span className="yellow ">Hostname: </span>
	<span className="blue ">for 5m with interval 1s in virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Pressing key </span>
	<span className="yellow ">BACKSPACE </span>
	<span className="blue ">36 times </span>
	<span className="blue ">on virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Typing </span>
	<span className="yellow ">"server" </span>
	<span className="blue ">with interval 30ms in virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Pressing key </span>
	<span className="yellow ">ENTER </span>
	<span className="blue ">on virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Waiting </span>
	<span className="yellow ">Full name for the new user </span>
	<span className="blue ">for 1m with interval 1s in virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Typing </span>
	<span className="yellow ">"server-login" </span>
	<span className="blue ">with interval 30ms in virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Pressing key </span>
	<span className="yellow ">ENTER </span>
	<span className="blue ">on virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Waiting </span>
	<span className="yellow ">Username for your account </span>
	<span className="blue ">for 1m with interval 1s in virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Pressing key </span>
	<span className="yellow ">ENTER </span>
	<span className="blue ">on virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Waiting </span>
	<span className="yellow ">Choose a password for the new user </span>
	<span className="blue ">for 1m with interval 1s in virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Typing </span>
	<span className="yellow ">"1111" </span>
	<span className="blue ">with interval 30ms in virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Pressing key </span>
	<span className="yellow ">ENTER </span>
	<span className="blue ">on virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Waiting </span>
	<span className="yellow ">Re-enter password to verify </span>
	<span className="blue ">for 1m with interval 1s in virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Typing </span>
	<span className="yellow ">"1111" </span>
	<span className="blue ">with interval 30ms in virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Pressing key </span>
	<span className="yellow ">ENTER </span>
	<span className="blue ">on virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Waiting </span>
	<span className="yellow ">Encrypt your home directory? </span>
	<span className="blue ">for 1m with interval 1s in virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="red bold">/home/alex/testo/macros.testo:25:2: Error while performing action wait Encrypt your home directory? on virtual machine server:<br/>	-Timeout<br/></span>
	<span className="red bold">[100%] Test </span>
	<span className="yellow bold">server_install_ubuntu</span>
	<span className="red bold"> FAILED in 0h:2m:3s<br/></span>
	<span className="">user$ </span>
</Terminal>

Как мы и предполагали, `if` сработал не совсем так, как мы бы хотели, поэтому давайте исправим параметр `default_password` так, чтобы он мог восприниматься как достаточно надежный:

```testo
param default_password "ThisIsStrongPassword"
```
Перезапустим тесты. Обратите внимание, что сейчас мы выполняем **только** тест `server_install_ubuntu`

<Terminal height="600px">
	<span className="">user$ sudo testo run ./ --stop_on_fail --param ISO_DIR /opt/iso --test_spec server_install_ubuntu --assume_yes<br/></span>
	<span className="blue bold">TESTS TO RUN:<br/></span>
	<span className="magenta ">server_install_ubuntu<br/></span>
	<span className="blue ">[  0%] Preparing the environment for test </span>
	<span className="yellow ">server_install_ubuntu<br/></span>
	<span className="blue ">[  0%] Restoring snapshot </span>
	<span className="yellow ">initial</span>
	<span className="blue "> for virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Running test </span>
	<span className="yellow ">server_install_ubuntu<br/></span>
	<span className="blue ">[  0%] Calling macro </span>
	<span className="yellow ">install_ubuntu(</span>
	<span className="yellow ">hostname="server"</span>
	<span className="yellow ">, </span>
	<span className="yellow ">login="server-login"</span>
	<span className="yellow ">, </span>
	<span className="yellow ">password="ThisIsStrongPassword"</span>
	<span className="yellow ">, </span>
	<span className="yellow ">is_weak_password=""</span>
	<span className="yellow ">)</span>
	<span className="blue "> in virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Starting virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Waiting </span>
	<span className="yellow ">English </span>
	<span className="blue ">for 1m with interval 1s in virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Pressing key </span>
	<span className="yellow ">ENTER </span>
	<span className="blue ">on virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Waiting </span>
	<span className="yellow ">Install Ubuntu Server </span>
	<span className="blue ">for 1m with interval 1s in virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Pressing key </span>
	<span className="yellow ">ENTER </span>
	<span className="blue ">on virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Waiting </span>
	<span className="yellow ">Choose the language </span>
	<span className="blue ">for 1m with interval 1s in virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Pressing key </span>
	<span className="yellow ">ENTER </span>
	<span className="blue ">on virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Waiting </span>
	<span className="yellow ">Select your location </span>
	<span className="blue ">for 1m with interval 1s in virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Pressing key </span>
	<span className="yellow ">ENTER </span>
	<span className="blue ">on virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Waiting </span>
	<span className="yellow ">Detect keyboard layout? </span>
	<span className="blue ">for 1m with interval 1s in virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Pressing key </span>
	<span className="yellow ">ENTER </span>
	<span className="blue ">on virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Waiting </span>
	<span className="yellow ">Country of origin for the keyboard </span>
	<span className="blue ">for 1m with interval 1s in virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Pressing key </span>
	<span className="yellow ">ENTER </span>
	<span className="blue ">on virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Waiting </span>
	<span className="yellow ">Keyboard layout </span>
	<span className="blue ">for 1m with interval 1s in virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Pressing key </span>
	<span className="yellow ">ENTER </span>
	<span className="blue ">on virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Waiting </span>
	<span className="yellow ">Primary network interface </span>
	<span className="blue ">for 1m with interval 1s in virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Pressing key </span>
	<span className="yellow ">ENTER </span>
	<span className="blue ">on virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Waiting </span>
	<span className="yellow ">Hostname: </span>
	<span className="blue ">for 5m with interval 1s in virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Pressing key </span>
	<span className="yellow ">BACKSPACE </span>
	<span className="blue ">36 times </span>
	<span className="blue ">on virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Typing </span>
	<span className="yellow ">"server" </span>
	<span className="blue ">with interval 30ms in virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Pressing key </span>
	<span className="yellow ">ENTER </span>
	<span className="blue ">on virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Waiting </span>
	<span className="yellow ">Full name for the new user </span>
	<span className="blue ">for 1m with interval 1s in virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Typing </span>
	<span className="yellow ">"server-login" </span>
	<span className="blue ">with interval 30ms in virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Pressing key </span>
	<span className="yellow ">ENTER </span>
	<span className="blue ">on virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Waiting </span>
	<span className="yellow ">Username for your account </span>
	<span className="blue ">for 1m with interval 1s in virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Pressing key </span>
	<span className="yellow ">ENTER </span>
	<span className="blue ">on virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Waiting </span>
	<span className="yellow ">Choose a password for the new user </span>
	<span className="blue ">for 1m with interval 1s in virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Typing </span>
	<span className="yellow ">"ThisIsStrongPassword" </span>
	<span className="blue ">with interval 30ms in virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Pressing key </span>
	<span className="yellow ">ENTER </span>
	<span className="blue ">on virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Waiting </span>
	<span className="yellow ">Re-enter password to verify </span>
	<span className="blue ">for 1m with interval 1s in virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Typing </span>
	<span className="yellow ">"ThisIsStrongPassword" </span>
	<span className="blue ">with interval 30ms in virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Pressing key </span>
	<span className="yellow ">ENTER </span>
	<span className="blue ">on virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Waiting </span>
	<span className="yellow ">Encrypt your home directory? </span>
	<span className="blue ">for 1m with interval 1s in virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Pressing key </span>
	<span className="yellow ">ENTER </span>
	<span className="blue ">on virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Waiting </span>
	<span className="yellow ">Is this time zone correct? </span>
	<span className="blue ">for 2m with interval 1s in virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Pressing key </span>
	<span className="yellow ">ENTER </span>
	<span className="blue ">on virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Waiting </span>
	<span className="yellow ">Partitioning method </span>
	<span className="blue ">for 1m with interval 1s in virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Pressing key </span>
	<span className="yellow ">ENTER </span>
	<span className="blue ">on virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Waiting </span>
	<span className="yellow ">Select disk to partition </span>
	<span className="blue ">for 1m with interval 1s in virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Pressing key </span>
	<span className="yellow ">ENTER </span>
	<span className="blue ">on virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Waiting </span>
	<span className="yellow ">Write the changes to disks and configure LVM? </span>
	<span className="blue ">for 1m with interval 1s in virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Pressing key </span>
	<span className="yellow ">LEFT </span>
	<span className="blue ">on virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Pressing key </span>
	<span className="yellow ">ENTER </span>
	<span className="blue ">on virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Waiting </span>
	<span className="yellow ">Amount of volume group to use for guided partitioning </span>
	<span className="blue ">for 1m with interval 1s in virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Pressing key </span>
	<span className="yellow ">ENTER </span>
	<span className="blue ">on virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Waiting </span>
	<span className="yellow ">Write the changes to disks? </span>
	<span className="blue ">for 1m with interval 1s in virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Pressing key </span>
	<span className="yellow ">LEFT </span>
	<span className="blue ">on virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Pressing key </span>
	<span className="yellow ">ENTER </span>
	<span className="blue ">on virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Waiting </span>
	<span className="yellow ">HTTP proxy information </span>
	<span className="blue ">for 3m with interval 1s in virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Pressing key </span>
	<span className="yellow ">ENTER </span>
	<span className="blue ">on virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Waiting </span>
	<span className="yellow ">How do you want to manage upgrades </span>
	<span className="blue ">for 6m with interval 1s in virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Pressing key </span>
	<span className="yellow ">ENTER </span>
	<span className="blue ">on virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Waiting </span>
	<span className="yellow ">Choose software to install </span>
	<span className="blue ">for 1m with interval 1s in virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Pressing key </span>
	<span className="yellow ">ENTER </span>
	<span className="blue ">on virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Waiting </span>
	<span className="yellow ">Install the GRUB boot loader to the master boot record? </span>
	<span className="blue ">for 10m with interval 1s in virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Pressing key </span>
	<span className="yellow ">ENTER </span>
	<span className="blue ">on virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Waiting </span>
	<span className="yellow ">Installation complete </span>
	<span className="blue ">for 1m with interval 1s in virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Unplugging dvd </span>
	<span className="yellow "> </span>
	<span className="blue ">from virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Pressing key </span>
	<span className="yellow ">ENTER </span>
	<span className="blue ">on virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Waiting </span>
	<span className="yellow ">server login: </span>
	<span className="blue ">for 2m with interval 1s in virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Typing </span>
	<span className="yellow ">"server-login" </span>
	<span className="blue ">with interval 30ms in virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Pressing key </span>
	<span className="yellow ">ENTER </span>
	<span className="blue ">on virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Waiting </span>
	<span className="yellow ">Password: </span>
	<span className="blue ">for 1m with interval 1s in virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Typing </span>
	<span className="yellow ">"ThisIsStrongPassword" </span>
	<span className="blue ">with interval 30ms in virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Pressing key </span>
	<span className="yellow ">ENTER </span>
	<span className="blue ">on virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Waiting </span>
	<span className="yellow ">Welcome to Ubuntu </span>
	<span className="blue ">for 1m with interval 1s in virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="blue ">[  0%] Taking snapshot </span>
	<span className="yellow ">server_install_ubuntu</span>
	<span className="blue "> for virtual machine </span>
	<span className="yellow ">server<br/></span>
	<span className="green bold">[100%] Test </span>
	<span className="yellow bold">server_install_ubuntu</span>
	<span className="green bold"> PASSED in 0h:5m:34s<br/></span>
	<span className="blue bold">PROCESSED TOTAL 1 TESTS IN 0h:5m:34s<br/></span>
	<span className="blue bold">UP-TO-DATE: 0<br/></span>
	<span className="green bold">RUN SUCCESSFULLY: 1<br/></span>
	<span className="red bold">FAILED: 0<br/></span>
	<span className="">user$ </span>
</Terminal>

Итак, тест на установку Ubuntu снова проходит. Теперь давайте представим, что по какой-то причине нам все-таки очень нужно установить именно слабый пароль на виртуальную машину `client`. Для этого надо модернизировать вызов макроса в тесте `client_install_ubuntu`

```testo
test client_install_ubuntu {
	client install_ubuntu("${client_hostname}", "${client_login}", "1111", "yes")
}
```

В этом вызове мы вместо пароля по-умолчанию `default_password` передаём явно пароль `1111`. Для того, чтобы "подсказать" макросу, что это слабый пароль, необходимо передать непустую строку в качестве четвертого параметра.

<Terminal height="600px">
	<span className="">user$ sudo testo run ./ --stop_on_fail --param ISO_DIR /opt/iso --test_spec client_install_ubuntu --assume_yes<br/></span>
	<span className="blue bold">TESTS TO RUN:<br/></span>
	<span className="magenta ">client_install_ubuntu<br/></span>
	<span className="blue ">[  0%] Preparing the environment for test </span>
	<span className="yellow ">client_install_ubuntu<br/></span>
	<span className="blue ">[  0%] Restoring snapshot </span>
	<span className="yellow ">initial</span>
	<span className="blue "> for virtual machine </span>
	<span className="yellow ">client<br/></span>
	<span className="blue ">[  0%] Running test </span>
	<span className="yellow ">client_install_ubuntu<br/></span>
	<span className="blue ">[  0%] Calling macro </span>
	<span className="yellow ">install_ubuntu(</span>
	<span className="yellow ">hostname="client"</span>
	<span className="yellow ">, </span>
	<span className="yellow ">login="client-login"</span>
	<span className="yellow ">, </span>
	<span className="yellow ">password="1111"</span>
	<span className="yellow ">, </span>
	<span className="yellow ">is_weak_password="yes"</span>
	<span className="yellow ">)</span>
	<span className="blue "> in virtual machine </span>
	<span className="yellow ">client<br/></span>
	<span className="blue ">[  0%] Starting virtual machine </span>
	<span className="yellow ">client<br/></span>
	<span className="blue ">[  0%] Waiting </span>
	<span className="yellow ">English </span>
	<span className="blue ">for 1m with interval 1s in virtual machine </span>
	<span className="yellow ">client<br/></span>
	<span className="blue ">[  0%] Pressing key </span>
	<span className="yellow ">ENTER </span>
	<span className="blue ">on virtual machine </span>
	<span className="yellow ">client<br/></span>
	<span className="blue ">[  0%] Waiting </span>
	<span className="yellow ">Install Ubuntu Server </span>
	<span className="blue ">for 1m with interval 1s in virtual machine </span>
	<span className="yellow ">client<br/></span>
	<span className="blue ">[  0%] Pressing key </span>
	<span className="yellow ">ENTER </span>
	<span className="blue ">on virtual machine </span>
	<span className="yellow ">client<br/></span>
	<span className="blue ">[  0%] Waiting </span>
	<span className="yellow ">Choose the language </span>
	<span className="blue ">for 1m with interval 1s in virtual machine </span>
	<span className="yellow ">client<br/></span>
	<span className="blue ">[  0%] Pressing key </span>
	<span className="yellow ">ENTER </span>
	<span className="blue ">on virtual machine </span>
	<span className="yellow ">client<br/></span>
	<span className="blue ">[  0%] Waiting </span>
	<span className="yellow ">Select your location </span>
	<span className="blue ">for 1m with interval 1s in virtual machine </span>
	<span className="yellow ">client<br/></span>
	<span className="blue ">[  0%] Pressing key </span>
	<span className="yellow ">ENTER </span>
	<span className="blue ">on virtual machine </span>
	<span className="yellow ">client<br/></span>
	<span className="blue ">[  0%] Waiting </span>
	<span className="yellow ">Detect keyboard layout? </span>
	<span className="blue ">for 1m with interval 1s in virtual machine </span>
	<span className="yellow ">client<br/></span>
	<span className="blue ">[  0%] Pressing key </span>
	<span className="yellow ">ENTER </span>
	<span className="blue ">on virtual machine </span>
	<span className="yellow ">client<br/></span>
	<span className="blue ">[  0%] Waiting </span>
	<span className="yellow ">Country of origin for the keyboard </span>
	<span className="blue ">for 1m with interval 1s in virtual machine </span>
	<span className="yellow ">client<br/></span>
	<span className="blue ">[  0%] Pressing key </span>
	<span className="yellow ">ENTER </span>
	<span className="blue ">on virtual machine </span>
	<span className="yellow ">client<br/></span>
	<span className="blue ">[  0%] Waiting </span>
	<span className="yellow ">Keyboard layout </span>
	<span className="blue ">for 1m with interval 1s in virtual machine </span>
	<span className="yellow ">client<br/></span>
	<span className="blue ">[  0%] Pressing key </span>
	<span className="yellow ">ENTER </span>
	<span className="blue ">on virtual machine </span>
	<span className="yellow ">client<br/></span>
	<span className="blue ">[  0%] Waiting </span>
	<span className="yellow ">Primary network interface </span>
	<span className="blue ">for 1m with interval 1s in virtual machine </span>
	<span className="yellow ">client<br/></span>
	<span className="blue ">[  0%] Pressing key </span>
	<span className="yellow ">ENTER </span>
	<span className="blue ">on virtual machine </span>
	<span className="yellow ">client<br/></span>
	<span className="blue ">[  0%] Waiting </span>
	<span className="yellow ">Hostname: </span>
	<span className="blue ">for 5m with interval 1s in virtual machine </span>
	<span className="yellow ">client<br/></span>
	<span className="blue ">[  0%] Pressing key </span>
	<span className="yellow ">BACKSPACE </span>
	<span className="blue ">36 times </span>
	<span className="blue ">on virtual machine </span>
	<span className="yellow ">client<br/></span>
	<span className="blue ">[  0%] Typing </span>
	<span className="yellow ">"client" </span>
	<span className="blue ">with interval 30ms in virtual machine </span>
	<span className="yellow ">client<br/></span>
	<span className="blue ">[  0%] Pressing key </span>
	<span className="yellow ">ENTER </span>
	<span className="blue ">on virtual machine </span>
	<span className="yellow ">client<br/></span>
	<span className="blue ">[  0%] Waiting </span>
	<span className="yellow ">Full name for the new user </span>
	<span className="blue ">for 1m with interval 1s in virtual machine </span>
	<span className="yellow ">client<br/></span>
	<span className="blue ">[  0%] Typing </span>
	<span className="yellow ">"client-login" </span>
	<span className="blue ">with interval 30ms in virtual machine </span>
	<span className="yellow ">client<br/></span>
	<span className="blue ">[  0%] Pressing key </span>
	<span className="yellow ">ENTER </span>
	<span className="blue ">on virtual machine </span>
	<span className="yellow ">client<br/></span>
	<span className="blue ">[  0%] Waiting </span>
	<span className="yellow ">Username for your account </span>
	<span className="blue ">for 1m with interval 1s in virtual machine </span>
	<span className="yellow ">client<br/></span>
	<span className="blue ">[  0%] Pressing key </span>
	<span className="yellow ">ENTER </span>
	<span className="blue ">on virtual machine </span>
	<span className="yellow ">client<br/></span>
	<span className="blue ">[  0%] Waiting </span>
	<span className="yellow ">Choose a password for the new user </span>
	<span className="blue ">for 1m with interval 1s in virtual machine </span>
	<span className="yellow ">client<br/></span>
	<span className="blue ">[  0%] Typing </span>
	<span className="yellow ">"1111" </span>
	<span className="blue ">with interval 30ms in virtual machine </span>
	<span className="yellow ">client<br/></span>
	<span className="blue ">[  0%] Pressing key </span>
	<span className="yellow ">ENTER </span>
	<span className="blue ">on virtual machine </span>
	<span className="yellow ">client<br/></span>
	<span className="blue ">[  0%] Waiting </span>
	<span className="yellow ">Re-enter password to verify </span>
	<span className="blue ">for 1m with interval 1s in virtual machine </span>
	<span className="yellow ">client<br/></span>
	<span className="blue ">[  0%] Typing </span>
	<span className="yellow ">"1111" </span>
	<span className="blue ">with interval 30ms in virtual machine </span>
	<span className="yellow ">client<br/></span>
	<span className="blue ">[  0%] Pressing key </span>
	<span className="yellow ">ENTER </span>
	<span className="blue ">on virtual machine </span>
	<span className="yellow ">client<br/></span>
	<span className="blue ">[  0%] Waiting </span>
	<span className="yellow ">Use weak password? </span>
	<span className="blue ">for 1m with interval 1s in virtual machine </span>
	<span className="yellow ">client<br/></span>
	<span className="blue ">[  0%] Pressing key </span>
	<span className="yellow ">LEFT </span>
	<span className="blue ">on virtual machine </span>
	<span className="yellow ">client<br/></span>
	<span className="blue ">[  0%] Pressing key </span>
	<span className="yellow ">ENTER </span>
	<span className="blue ">on virtual machine </span>
	<span className="yellow ">client<br/></span>
	<span className="blue ">[  0%] Waiting </span>
	<span className="yellow ">Encrypt your home directory? </span>
	<span className="blue ">for 1m with interval 1s in virtual machine </span>
	<span className="yellow ">client<br/></span>
	<span className="blue ">[  0%] Pressing key </span>
	<span className="yellow ">ENTER </span>
	<span className="blue ">on virtual machine </span>
	<span className="yellow ">client<br/></span>
	<span className="blue ">[  0%] Waiting </span>
	<span className="yellow ">Is this time zone correct? </span>
	<span className="blue ">for 2m with interval 1s in virtual machine </span>
	<span className="yellow ">client<br/></span>
	<span className="blue ">[  0%] Pressing key </span>
	<span className="yellow ">ENTER </span>
	<span className="blue ">on virtual machine </span>
	<span className="yellow ">client<br/></span>
	<span className="blue ">[  0%] Waiting </span>
	<span className="yellow ">Partitioning method </span>
	<span className="blue ">for 1m with interval 1s in virtual machine </span>
	<span className="yellow ">client<br/></span>
	<span className="blue ">[  0%] Pressing key </span>
	<span className="yellow ">ENTER </span>
	<span className="blue ">on virtual machine </span>
	<span className="yellow ">client<br/></span>
	<span className="blue ">[  0%] Waiting </span>
	<span className="yellow ">Select disk to partition </span>
	<span className="blue ">for 1m with interval 1s in virtual machine </span>
	<span className="yellow ">client<br/></span>
	<span className="blue ">[  0%] Pressing key </span>
	<span className="yellow ">ENTER </span>
	<span className="blue ">on virtual machine </span>
	<span className="yellow ">client<br/></span>
	<span className="blue ">[  0%] Waiting </span>
	<span className="yellow ">Write the changes to disks and configure LVM? </span>
	<span className="blue ">for 1m with interval 1s in virtual machine </span>
	<span className="yellow ">client<br/></span>
	<span className="blue ">[  0%] Pressing key </span>
	<span className="yellow ">LEFT </span>
	<span className="blue ">on virtual machine </span>
	<span className="yellow ">client<br/></span>
	<span className="blue ">[  0%] Pressing key </span>
	<span className="yellow ">ENTER </span>
	<span className="blue ">on virtual machine </span>
	<span className="yellow ">client<br/></span>
	<span className="blue ">[  0%] Waiting </span>
	<span className="yellow ">Amount of volume group to use for guided partitioning </span>
	<span className="blue ">for 1m with interval 1s in virtual machine </span>
	<span className="yellow ">client<br/></span>
	<span className="blue ">[  0%] Pressing key </span>
	<span className="yellow ">ENTER </span>
	<span className="blue ">on virtual machine </span>
	<span className="yellow ">client<br/></span>
	<span className="blue ">[  0%] Waiting </span>
	<span className="yellow ">Write the changes to disks? </span>
	<span className="blue ">for 1m with interval 1s in virtual machine </span>
	<span className="yellow ">client<br/></span>
	<span className="blue ">[  0%] Pressing key </span>
	<span className="yellow ">LEFT </span>
	<span className="blue ">on virtual machine </span>
	<span className="yellow ">client<br/></span>
	<span className="blue ">[  0%] Pressing key </span>
	<span className="yellow ">ENTER </span>
	<span className="blue ">on virtual machine </span>
	<span className="yellow ">client<br/></span>
	<span className="blue ">[  0%] Waiting </span>
	<span className="yellow ">HTTP proxy information </span>
	<span className="blue ">for 3m with interval 1s in virtual machine </span>
	<span className="yellow ">client<br/></span>
	<span className="blue ">[  0%] Pressing key </span>
	<span className="yellow ">ENTER </span>
	<span className="blue ">on virtual machine </span>
	<span className="yellow ">client<br/></span>
	<span className="blue ">[  0%] Waiting </span>
	<span className="yellow ">How do you want to manage upgrades </span>
	<span className="blue ">for 6m with interval 1s in virtual machine </span>
	<span className="yellow ">client<br/></span>
	<span className="blue ">[  0%] Pressing key </span>
	<span className="yellow ">ENTER </span>
	<span className="blue ">on virtual machine </span>
	<span className="yellow ">client<br/></span>
	<span className="blue ">[  0%] Waiting </span>
	<span className="yellow ">Choose software to install </span>
	<span className="blue ">for 1m with interval 1s in virtual machine </span>
	<span className="yellow ">client<br/></span>
	<span className="blue ">[  0%] Pressing key </span>
	<span className="yellow ">ENTER </span>
	<span className="blue ">on virtual machine </span>
	<span className="yellow ">client<br/></span>
	<span className="blue ">[  0%] Waiting </span>
	<span className="yellow ">Install the GRUB boot loader to the master boot record? </span>
	<span className="blue ">for 10m with interval 1s in virtual machine </span>
	<span className="yellow ">client<br/></span>
	<span className="blue ">[  0%] Pressing key </span>
	<span className="yellow ">ENTER </span>
	<span className="blue ">on virtual machine </span>
	<span className="yellow ">client<br/></span>
	<span className="blue ">[  0%] Waiting </span>
	<span className="yellow ">Installation complete </span>
	<span className="blue ">for 1m with interval 1s in virtual machine </span>
	<span className="yellow ">client<br/></span>
	<span className="blue ">[  0%] Unplugging dvd </span>
	<span className="yellow "> </span>
	<span className="blue ">from virtual machine </span>
	<span className="yellow ">client<br/></span>
	<span className="blue ">[  0%] Pressing key </span>
	<span className="yellow ">ENTER </span>
	<span className="blue ">on virtual machine </span>
	<span className="yellow ">client<br/></span>
	<span className="blue ">[  0%] Waiting </span>
	<span className="yellow ">client login: </span>
	<span className="blue ">for 2m with interval 1s in virtual machine </span>
	<span className="yellow ">client<br/></span>
	<span className="blue ">[  0%] Typing </span>
	<span className="yellow ">"client-login" </span>
	<span className="blue ">with interval 30ms in virtual machine </span>
	<span className="yellow ">client<br/></span>
	<span className="blue ">[  0%] Pressing key </span>
	<span className="yellow ">ENTER </span>
	<span className="blue ">on virtual machine </span>
	<span className="yellow ">client<br/></span>
	<span className="blue ">[  0%] Waiting </span>
	<span className="yellow ">Password: </span>
	<span className="blue ">for 1m with interval 1s in virtual machine </span>
	<span className="yellow ">client<br/></span>
	<span className="blue ">[  0%] Typing </span>
	<span className="yellow ">"1111" </span>
	<span className="blue ">with interval 30ms in virtual machine </span>
	<span className="yellow ">client<br/></span>
	<span className="blue ">[  0%] Pressing key </span>
	<span className="yellow ">ENTER </span>
	<span className="blue ">on virtual machine </span>
	<span className="yellow ">client<br/></span>
	<span className="blue ">[  0%] Waiting </span>
	<span className="yellow ">Welcome to Ubuntu </span>
	<span className="blue ">for 1m with interval 1s in virtual machine </span>
	<span className="yellow ">client<br/></span>
	<span className="blue ">[  0%] Taking snapshot </span>
	<span className="yellow ">client_install_ubuntu</span>
	<span className="blue "> for virtual machine </span>
	<span className="yellow ">client<br/></span>
	<span className="green bold">[100%] Test </span>
	<span className="yellow bold">client_install_ubuntu</span>
	<span className="green bold"> PASSED in 0h:5m:16s<br/></span>
	<span className="blue bold">PROCESSED TOTAL 1 TESTS IN 0h:5m:16s<br/></span>
	<span className="blue bold">UP-TO-DATE: 0<br/></span>
	<span className="green bold">RUN SUCCESSFULLY: 1<br/></span>
	<span className="red bold">FAILED: 0<br/></span>
	<span className="">user$ </span>
</Terminal>

Мы видим, что наше решение работает - теперь макрос `install_ubuntu` работает как при достаточно надежном пароле, так и при слабом. Но, конечно, такой способ управления сценарием не слишком удобен. Если бы в нашем макросе было еще несколько ветвлений (а они там все ещё требуются), то пришлось бы вводить новые аргументы, и рано или поздно их станет слишком много и в них можно будет запутаться. К тому же при каждом вызове макроса нужно держать в голове, по какому именно пути нам нужно "пустить" макрос в каждом конкретном случае.

Поэтому в языке `testo-lang` существует возможность конструировать условия на основе содержимого экрана.

## Условия на основе содержимого экрана

Для того, чтобы строить условия на основе содержмого экрана, в языке `testo-lang` существует проверка `check`. Её формат очень похож на формат действия `wait`, но её принцип действия несколько другой: если действие `wait` пытается дождаться некоторого события на экране и генерирует ошибку, если этого события не произошло за указанный промежуток времени, то проверка `check` в случае, если событие так и не наступило за заданный промежуток времени, просто возвращает `false`. Проверку `check` можно использовать только внутри условных выражений внутри `if`.

Давайте посмотрим на такую проверку в деле.

```testo
macro install_ubuntu(hostname, login, password = "${default_password}") {
	..
	wait "Re-enter password to verify"; type "${password}"; press Enter
	if (check "Use weak password" timeout 3s) {
		press Left, Enter
	}
	wait "Encrypt your home directory?"; press Enter
	...
```

Вместо того, чтобы полагаться на значение аргумента `is_weak_password`, наш макрос теперь полагается на фактическое положение вещей - на содержимое экрана. Наша проверка, приведенная выше, дословно означает следующее: если в течение трех секунд на экране появится надпись `Use weak password`, то необходимо выполнить действие `press Left, Enter`. Если надпись появится раньше, чем через 3 секунды - то проверка тут же закончится.

Если бы мы не указали `timeout 3s` - то по умолчанию `check` будет проверять **только** содержимое экрана на текущий момент времени, без выжидания каких-либо таймаутов. В нашем случае это не очень подходит, потому что экран `Use weak password` может появиться после предыдущего не моментально, а, скажем, через 0,5-1 секунду. Поэтому таким способом мы как бы говорим себе: "Ну, если экран `Use weak password` не появится за 3 секунды, он вообще не появится".

Конечно же, теперь нам не нужен аргумент `is_weak_password`, поэтому мы со спокойной совестью снова от него избавились.

Не забываем подкорректировать вызов макроса в `client_install_ubuntu` и запускаем оба теста на установку ещё раз.

```testo
test client_install_ubuntu {
	client install_ubuntu("${client_hostname}", "${client_login}", "1111")
}
```

<Terminal height="300px">
	<span className="">user$ sudo testo run ./ --stop_on_fail --param ISO_DIR /opt/iso --test_spec \*_install_ubuntu --assume_yes<br/></span>
	<span className="blue bold">TESTS TO RUN:<br/></span>
	<span className="magenta ">server_install_ubuntu<br/></span>
	<span className="magenta ">client_install_ubuntu<br/></span>
	<span className="">...<br/></span>
	<span className="blue bold">PROCESSED TOTAL 2 TESTS IN 0h:11m:14s<br/></span>
	<span className="blue bold">UP-TO-DATE: 0<br/></span>
	<span className="green bold">RUN SUCCESSFULLY: 2<br/></span>
	<span className="red bold">FAILED: 0<br/></span>
	<span className="">user$ </span>
</Terminal>

Оба теста успешно прошли, а это значит, что пора двигаться дальше.

## Один макрос - разное количество интерфейсов

Мы разобрались с разными сценариями установки при разных паролях. Но мы сталкивались и с другой проблемой - при разном количестве сетевых адаптеров установка также отличается.

Давайте внимательно поисследуем этот участок макроса по установке Ubuntu.

```testo
wait "Keyboard layout"; press Enter
#wait "No network interfaces detected" timeout 5m; press Enter
wait "Primary network interface"; press Enter
wait "Hostname:" timeout 5m; press Backspace*36; type "${hostname}"; press Enter
```

Всего может быть три возможных варианта:

1. Если сетевых адаптеров вообще нет, то появляется экран с предупреждением о том, что сетевые адаптеры не найдены, из-за чего нам дополнительно приходилось нажимать Enter в первых уроках. После чего сразу появлялся экран с `Hostname`.
2. Если сетевой адаптер ровно один, то после `Keyboard layout` никаких предупреждений и дополнительных экранов не возникало, и установщик Ubuntu сразу предлагал выбрать `Hostname`.
3. Если сетевых адаптеров два или больше, то после `Keyboard layout` появляется экран с предложение выбрать главный сетевой интерфейс. После выбора интерфейса появляется экран `Hostname`.

Получается, что мы не можем быть уверены, какой именно экран у нас появится после `keyboard layout`: или `No network interfaces detected` или `Primary network interface` или `Hostname`. Как же нам объединить все три возможных варианта в одном макросе?

Для этого мы воспользуемся приёмом, который по сути очень напоминает известный многим оператор `switch-case`, правда выглядит по-другому.

Для начала мы воспользуемся возможностью действия `wait` ожидать не фиксированную надпись, а целые логические выражения, состоящие из надписей (поподробнее про поисковые выражения можно почитать [здесь](/docs/lang/actions#формат-выражений-для-команд-wait-и-check)):

```testo
wait "Keyboard layout"; press Enter
wait "No network interfaces detected" || "Primary network interface" || "Hostname:" timeout 5m
```

> Сложные поисковые выражения можно делать как в действии `wait`, так и в условии `check`

Этим действием мы говорим, что нам устроит, если на экране появится хотя бы одна из перечисленных надписей. Такой `wait` успешно сработает независимо от того, какой именно экран у нас появится. Пол дела сделано.

Но нам мало дождаться хоть какого-нибудь экрана. Нам еще нужно совершать разные действия, в зависимости от того, какой именно экран у нас высветился. В этом нам поможет уже знакомый `if(check)`

```testo
wait "No network interfaces detected" || "Primary network interface" || "Hostname:" timeout 5m
if (check "No network interfaces detected") {
	press Right, Enter
} else if (check "Primary network interface"){
	press Enter
}
wait "Hostname:" timeout 5m; press Backspace*36; type "${hostname}"; press Enter
```

Получается примерно следующая картина: сначала мы дожидаемся любого из устраивающих нас экранов, а затем с помощью перебора пытаемся понять, какой именно экран мы получили. И применяем соответствующие действия. Конечно, нам не хватает ещё секции `else`, которая бы соответствала экрану `Hostname`, но т.к. в двух других случаях после определенных действий всё равно затем требуется ожидать экран `Hostname`, мы можем себе позволить немного сократить количество кода.

> Заметим, что в этом случае в `check` не указывается `timeout`, т.к. нас интересует состояние экрана на текущий момент, а не в течение некоторого времени. Какое бы событие не наступило на экране, оно уже точно наступило - в этом мы уверены.

Остался лишь один нерешённый вопрос. Он кроется в этом участке макроса

```testo
wait "Encrypt your home directory?"; press Enter
#wait "Select your timezone" timeout 2m; press Enter
wait "Is this time zone correct?" timeout 2m; press Enter
wait "Partitioning method"; press Enter
```

В зависимости от того, есть ли у виртуальной машины доступ в Интернет или нет, могут появляться разные экраны: либо с предложением самостоятельно выбрать часовой пояс, либо с готовым предположением относительно вашего местоположения. К счастью, в обоих случаях действия с нашей стороны должны быть одинаковыми: необходимо нажать Enter. Поэтому этот участок сценария можно унифицировать без `if`.

```testo
wait "Encrypt your home directory?"; press Enter
wait "Select your time zone" || "Is this time zone correct?" timeout 2m; press Enter
wait "Partitioning method"; press Enter
```

Готово! Теперь наш макрос `install_ubuntu` работает в самых разных условиях и с самыми разными виртуальными машинами. Мы можем вынести этот макрос в отдельный файл и фактически забыть про него. Всё, что нам теперь нужно для установки Ubuntu Server на виртуальную машину в тесте - это вызывать макрос, не заботясь о деталях его реализации.

Попробуйте самостоятельно поэкспериментировать с этим макросом и с разными виртуальными машинами. Попробуйте различные комбинации количества сетевых адаптеров, доступа в Интернет и сложности пароля. Вы легко убедитесь в том, что наш макрос успешно отрабатывает при разных условиях.

## Итоги

Условный оператор `if` в языке `testo-lang` позволяет менять ход проведения тестовых сценариев в зависимости от различных условий, в том числе на основе происходящего на экране. С помощью этого инструмента мы можете писать более гибкие тесты и макросы, которые будут работать в разных условиях.

> Конечно же, в данном уроке мы рассмотрели не все возможности оператора `if`. В условиях можно писать целые выражения с использованиям унарных и бинарных операторов, сравнений и прочего. Дополнительную информацию можно посмотреть [здесь](/docs/lang/if)

Готовые скрипты можно найти [здесь](https://github.com/CIDJEY/Testo_tutorials/tree/master/10)

